# 리밸런싱 기능 개선 계획 (2026-01-25)

## 1. 개요
본 문서는 매크로 트레이딩 리밸런싱 시스템의 개선 계획을 기술합니다. 주요 개선 사항은 자동화 스케줄러 도입, MP/Sub-MP 변경에 따른 리밸런싱 범위 세분화, 그리고 타이밍 리스크 완화를 위한 5일 분할 진입 전략 구현입니다.

## 2. 주요 개선 내용

### 2.1 스케줄러 구현
*   **현재**: 자동 실행 기능 부재.
*   **개선안**: Python 기반 스케줄러(기존 runner 확장 또는 `APScheduler`/cron 사용)를 구현하여 **매일 아침 09:40 (KST)** 에 리밸런싱 조건을 체크하고 실행합니다.
    *   **이유**: 장 시작(09:00) 후 시장이 어느 정도 안정화된 시점에 실행하여 급격한 변동성을 피합니다.

### 2.2 리밸런싱 범위 로직 (Scope)
*   **MP 변경 발생 시**:
    *   범위: **전체 자산 (All Assets)**.
    *   동작: 새로운 자산군(Asset Class) 비중에 맞춰 전체 포트폴리오를 리밸런싱합니다.
*   **Sub-MP 변경 발생 시**:
    *   범위: **부분 집합 (변경된 자산군만 해당)**.
    *   동작: 부분 리밸런싱(Partial Rebalancing). 다른 자산군에 영향을 주지 않고, 해당 자산군 내의 종목 구성만 최적화합니다.

### 2.3 분할 진입 전략 (Split Entry)
*   **개념**: 타이밍 리스크를 줄이기 위해 매매를 **5거래일**에 걸쳐 분할 실행합니다.
*   **매커니즘**:
    *   **Flag 관리**: DB에 `is_rebalancing_active` 상태 플래그 사용.
    *   **연속 스냅샷**: 매일 최신 가격을 반영하여 `목표 수량` vs `현재 수량`을 재계산합니다.
    *   **알고리즘 (Fixed Schedule)**:
        *   **1일차**: 목표 수량 차분(Total Delta)의 **30%** 실행.
        *   **2~4일차**: 각각 **20%** 실행.
        *   **5일차**: 남은 **10%** (잔량 전량 처리).
        *   *비고*: 매일 리밸런싱 시점의 최신 가격을 반영하여 목표 수량이 변동될 경우, 해당 시점의 남은 비율에 맞춰 수량을 재계산합니다.

### 2.4 케이스 분석 (충돌 해결) - [수정됨]
수수료 효율성과 슬리피지(Slippage)를 고려하여 대응 방안을 수정했습니다.

#### Case 1: MP 분할 진입 중 -> Sub-MP 변경 발생
*   **상황**: 전체 MP 리밸런싱 진행 중(예: 2일차)에 특정 섹터의 종목 선정(Sub-MP)이 변경됨.
*   **수정된 대응**: **변경된 Sub-MP 자산군만 1일차(Local Scope)로 전환**.
    *   **나머지 자산군**: 기존 진행 중이던 MP 리밸런싱 스케줄을 유지하거나, 중요도가 낮다면 중단하고 현 상태 유지(Drift Check에 맡김). 불필요한 매매(Global Reset으로 인한 미세 조정)를 방지하여 수수료를 절감합니다.
    *   **변경된 자산군**: 해당 자산군(예: 주식)만 **별도의 Sub-MP 리밸런싱**을 1일차부터 시작합니다.
    *   **진입 강도 조절**: 급격한 포트폴리오 교체(Pivot)로 인한 슬리피지를 줄이기 위해, **1일차 진입 비중을 50%가 아닌 20%(1/5) 또는 30%로 낮추어** 부드럽게 진입합니다.

#### Case 2: Sub-MP 분할 진입 중 -> MP 변경 발생
*   **상황**: 주식형 자산 내 종목 교체 진행 중(예: 3일차)에 MP가 변경되어 "주식 비중 축소" 지시가 내려옴.
*   **수정된 대응**: **Sub-MP 분할 중단, MP 리밸런싱(Global) 시작**.
    *   **로직**: 이것은 불가피한 전략 변경이므로 Global Scope로 전환해야 합니다.
    *   **효율화**: 기존에 매수하던 종목을 즉시 매도하는 비효율을 줄이기 위해, 이미 구현된 **`portfolio_calculator.calculate_net_trades`** 로직을 활용하여 철저한 **Netting(순매매) 계산**을 수행합니다.
        *   기존 보유량 + 진행 중 매수량 vs 신규 목표량을 비교하여, 불필요한 매도/매수를 최소화하고 최종 목표 차분(Delta)에 대해서만 1/N 분할 진입합니다.
    *   **진입 강도 조절**: 전략 변경 시의 충격을 완화하기 위해, **1일차 강제 50% 집행 룰을 적용하지 않고**, 변경 폭에 따라 **균등 분할(1/N)** 로직을 적용할 수 있도록 유연성을 둡니다.

### 2.5 신호 안정성 검증 (3-Day Rule)
*   **목표**: LLM의 일시적인 판단 변화(Noise)로 인한 잦은 리밸런싱을 방지합니다.
*   **로직 (Debouncing)**:
    *   MP 또는 Sub-MP 변경이 감지되면 즉시 실행하지 않고 **대기(Pending)** 상태로 둡니다.
    *   **3일 연속**으로 동일한 변경 값이 유지될 때만 리밸런싱을 트리거합니다.
    *   중간에 값이 다시 바뀌거나 원래대로 돌아오면 카운트를 초기화합니다.
*   **진행 중 변경 시 (Conflict 상황)**:
    *   리밸런싱 실행 중 새로운 변경 신호가 감지되면, 즉시 **기존 리밸런싱을 일시 정지(Pause)**합니다.
    *   **이유**: 새로운 신호가 확정될 경우 기존 방향의 매매는 수수료 낭비가 될 수 있으므로, 방향성이 확실해질 때까지 매매를 멈춥니다.
    *   **후속 처리**:
        *   신호가 3일 뒤 **확정(Confirmed)**되면: 기존 리밸런싱을 폐기하고 새로운 목표로 리밸런싱을 시작합니다.
        *   신호가 **취소(Reverted)**되면: 다시 이전 목표가 유효해지므로 멈췄던 리밸런싱을 재개(Resume)합니다.
    *   *근거*: 3일 가격 추동(Price Thrust) 지표 분석 결과, 3일간의 검증이 노이즈 비용(Whipsaw) 대비 추세 포착의 이익이 큼이 통계적으로 유효함 (분석 리포트 1.1절 참고).

### 2.6 Sub-MP 최적화 알고리즘 (HRP)
*   **현황**: 단순 비중 조절(Rule-based 또는 MVO).
*   **변경안**: HRP 등 복잡한 알고리즘 도입을 **보류(Deferred)** 하고, **단순 비중 조절 방식 유지 및 개선**에 집중합니다.
*   **내용**:
    *   초기 복잡도를 낮추기 위해 별도의 최적화 엔진(PyPortfolioOpt 등) 없이 **직관적인 비중 조절(Simple Weighting)** 로직으로 Sub-MP를 운용합니다.
    *   Sub-MP 내 종목 간의 비중은 동일 비중(Equal Weight) 또는 시가총액/유동성 기반의 단순 규칙을 따릅니다.
    *   *추후 고려*: 운영 데이터가 충분히 쌓인 후, 리스크 분산 효과가 필요하다고 판단될 때 HRP 알고리즘 도입을 재검토합니다.

### 2.7 테스트 및 시뮬레이션 환경 (Test Environment) - [신규]
*   **목적**: 복잡한 리밸런싱 로직(3일 대기, 분할 진입)을 안전하게 검증하고 디버깅하기 위함.
*   **주요 기능**:
    1.  **Test Admin 대시보드**: 현재 리밸런싱 진행 상태(State), 대기 중인 신호(Pending Signal), 실행 내역 등을 시각화.
    2.  **Time Travel (시간 여행)**:
        *   `Date + Time` 설정 기능을 제공하여 특정 날짜와 **시간(08:30, 09:40 등)** 으로 시스템 시계를 강제 동기화.
        *   **08:30**: 거시경제 분석(Macro Analysis) 및 신호 생성 트리거 테스트.
        *   **09:40**: 리밸런싱 실행(Execution) 및 주문 전송 테스트.
        *   `+1 Day` 버튼을 누르면 다음 날의 지정된 default 시간(08:00)으로 이동.
    3.  **Macro Prompt Editor**:
        *   거시경제 분석용 LLM 프롬프트를 웹 UI에서 직접 수정하고 테스트 실행.
        *   결과(Json/Text)를 즉시 확인하여 프롬프트 최적화 작업 지원.
    4.  **실전 매매 로직 연동**:
        *   별도의 모의투자 Mock을 만들지 않고, **실제 Paper Trading 프로필**을 사용하여 `OrderExecutor`를 가동.
        *   실제 증권사 API(또는 모의투자 API)를 통해 주문이 나가는지 확인.

## 3. 단계별 구현 계획 (Phased Implementation)

### Phase 1: 테스트 및 시뮬레이션 환경 구축 (Test-First)
- [ ] **Test Admin 페이지**: 리밸런싱 현황 시각화 및 제어 대시보드.
- [ ] **Macro Prompt Editor**: 거시경제 분석용 프롬프트 테스트 입력창 & LLM 연동 테스트.
- [ ] **Time Travel & DB**: 날짜 강제 이동(`+1 Day`) 기능 및 `rebalancing_state` 등 기초 테이블 설계.
- [ ] **Paper Trading 연동**: 실전 프로필 기반 가상 매매 연결 (실제 로직 사용).

### Phase 2: 핵심 로직 및 인프라 구현 (Core Logic)
- [ ] **스케줄러**: 매일 09:40 실행 크론잡 구현.
- [ ] **신호 검증기 (3-Day Rule)**: 3일 연속 신호 대기 및 확정/취소 로직.
- [ ] **범위(Scope) 로직**: Global(MP) vs Local(Sub-MP) 변경 감지.
- [ ] **분할 진입 & Netting**: 5일 분할 매매 계산 및 `calculate_net_trades` 최적화.

### Phase 3: 통합 및 고도화 (Integration)
- [ ] **시나리오 테스트**: MP/Sub-MP 충돌 상황(Case 1, 2) 시뮬레이션 검증.
- [ ] **Simple Weighting**: Sub-MP 단순 비중 조절 로직 적용.
- [ ] **모의투자 검증**: 1주간 자동 운용(Drift -> Signal -> Execution) 테스트.
- [ ] **프로덕션 배포**: 라이브 환경 적용 및 모니터링 알림 설정.
