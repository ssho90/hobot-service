# 리밸런싱 알고리즘 설계 문서

## 1. 개요

### 1.1 목적
본 문서는 한국투자증권 API를 활용하여 AI 분석을 통해 결정된 Model Portfolio(MP)와 Sub-MP 비율을 기반으로 자동 리밸런싱 매매를 수행하는 알고리즘을 설계합니다.

### 1.2 핵심 원칙
- **AI 기반 의사결정**: 거시경제 데이터와 뉴스를 분석하여 최적의 자산 배분 결정
- **계층적 포트폴리오 구조**: MP(전체 자산 배분) → Sub-MP(자산군별 세부 배분) → 개별 ETF
- **자동화된 리밸런싱**: 편차 임계값 초과 시 자동으로 목표 비율로 조정
- **비용 최적화**: 거래 비용을 고려하여 불필요한 매매 방지
- **안전성 우선**: 리스크 관리 및 예외 상황 처리

---

## 2. 시스템 아키텍처

### 2.1 전체 워크플로우

```
[AI 분석 모듈]
    ↓
[MP 결정] → [Sub-MP 결정]
    ↓
[목표 비율 계산]
    ↓
[현재 포트폴리오 조회] (KIS API)
    ↓
[편차 계산]
    ↓
[리밸런싱 필요 여부 판단]
    ↓
[매매 계획 수립]
    ↓
[거래 비용 검증]
    ↓
[리밸런싱 실행] (KIS API)
    ↓
[실행 결과 기록]
```

### 2.2 주요 구성 요소

1. **AI 전략가 모듈 (ai_strategist.py)**
   - FRED 데이터 및 경제 뉴스 분석
   - MP 및 Sub-MP 결정
   - 목표 자산 배분 비율 산출

2. **한국투자증권 API 모듈 (kis_api.py)**
   - 계좌 잔고 조회
   - 현재가 조회
   - 매수/매도 주문 실행
   - 주문 체결 확인

3. **리밸런싱 엔진 (본 문서에서 설계)**
   - 편차 계산 및 분석
   - 매매 계획 수립
   - 거래 비용 계산
   - 실행 로직 제어

4. **설정 관리 (macro_trading_config.json)**
   - 리밸런싱 임계값
   - ETF 매핑 정보
   - 실행 시간 및 스케줄

---

## 3. MP 및 Sub-MP 기반 목표 비율 결정

### 3.1 MP (Model Portfolio) 구조

MP는 전체 포트폴리오의 자산군별 배분 비율을 정의합니다:

- **MP-1 (Risk On)**: 주식 80%, 채권 10%, 대체투자 5%, 현금 5%
- **MP-2 (Reflation)**: 주식 50%, 채권 10%, 대체투자 30%, 현금 10%
- **MP-3 (Neutral)**: 주식 40%, 채권 40%, 대체투자 10%, 현금 10%
- **MP-4 (Defensive)**: 주식 20%, 채권 50%, 대체투자 20%, 현금 10%
- **MP-5 (Recession)**: 주식 10%, 채권 60%, 대체투자 10%, 현금 20%

### 3.2 Sub-MP 구조

각 자산군 내에서 세부 ETF 배분을 결정합니다:

#### 3.2.1 주식 (Stocks) Sub-MP
- **Eq-A (Aggressive)**: 나스닥 50%, S&P500 30%, 배당주 20%
- **Eq-N (Neutral)**: S&P500 50%, 나스닥 30%, 배당주 20%
- **Eq-D (Defensive)**: 배당주 50%, S&P500 30%, 나스닥 20%

#### 3.2.2 채권 (Bonds) Sub-MP
- **Bnd-L (Long Duration)**: 미국 장기채 80%, 한국 단기채 20%
- **Bnd-N (Balanced)**: 미국 장기채 50%, 한국 단기채 50%
- **Bnd-S (Short Duration)**: 한국 단기채 80%, 미국 장기채 20%

#### 3.2.3 대체투자 (Alternatives) Sub-MP
- **Alt-I (Inflation Fighter)**: 금 80%, 달러 20%
- **Alt-C (Crisis Hedge)**: 달러 70%, 금 30%

### 3.3 목표 비율 계산 공식

```
목표 비율 계산:
1. MP에서 자산군별 비율 획득: MP_allocation[asset_class]
2. Sub-MP에서 자산군 내 ETF별 비율 획득: Sub_MP_allocation[etf_category]
3. 최종 목표 비율 = MP_allocation[asset_class] × Sub_MP_allocation[etf_category]

예시:
- MP-1 선택, Stocks = 80%
- Eq-A 선택, 나스닥 = 50%
- 최종 목표: 나스닥 ETF = 80% × 50% = 40%
```

### 3.4 AI 의사결정 프로세스

1. **입력 데이터 수집**
   - FRED 정량 시그널 (금리 곡선, 실질 금리, 하이일드 스프레드 등)
   - 경제 뉴스 (최근 7일간 주요 경제 이벤트)
   - 이전 MP/Sub-MP 결정 이력

2. **MP 결정**
   - LLM이 거시경제 상황을 분석하여 5개 MP 중 최적 선택
   - 결정 근거와 함께 JSON 형식으로 반환

3. **Sub-MP 결정**
   - 선택된 MP를 기반으로 각 자산군별 Sub-MP 결정
   - 자산군 비중이 0%인 경우 해당 Sub-MP는 None

4. **목표 비율 최종 산출**
   - MP 비율 × Sub-MP 비율로 개별 ETF 목표 비율 계산
   - 데이터베이스에 저장 (target_allocation 테이블)

---

## 4. 리밸런싱 알고리즘 상세 설계

### 4.1 편차 계산 및 분석

#### 4.1.1 현재 포트폴리오 조회
- KIS API `get_balance()` 호출
- 보유 종목별 평가금액 및 수량 파악
- 총 평가금액 계산: `total_eval_amount = sum(각 종목 평가금액) + 현금`

#### 4.1.2 현재 비율 계산
```
현재 비율[ETF] = (해당 ETF 평가금액 / 총 평가금액) × 100
```

#### 4.1.3 편차 계산
```
편차[ETF] = |목표 비율[ETF] - 현재 비율[ETF]|
```

#### 4.1.4 리밸런싱 필요 여부 판단
- 전체 포트폴리오 편차 확인
- 임계값(기본 5%) 초과 여부 검사
- 편차가 임계값을 초과하는 자산이 하나라도 있으면 리밸런싱 실행

### 4.2 매매 계획 수립

#### 4.2.1 자산군별 목표 금액 계산
```
목표 금액[자산군] = 총 평가금액 × MP_allocation[자산군] / 100
```

#### 4.2.2 개별 ETF 목표 금액 계산
```
목표 금액[ETF] = 총 평가금액 × 목표 비율[ETF] / 100
```

#### 4.2.3 매매 필요 금액 계산
```
매매 필요 금액[ETF] = 목표 금액[ETF] - 현재 평가금액[ETF]
```

#### 4.2.4 매매 우선순위 결정
1. **매도 우선**: 편차가 큰 초과 비중 자산부터 매도
   - 편차 내림차순 정렬
   - 매도로 인한 현금 확보 우선

2. **매수 실행**: 부족 비중 자산 매수
   - 편차 내림차순 정렬
   - 확보된 현금으로 매수

#### 4.2.5 부분 리밸런싱 전략
- 모든 자산을 한 번에 조정하지 않고, 편차가 임계값(5%) 이상인 자산만 우선 처리
- 거래 비용을 최소화하면서 점진적으로 목표 비율에 접근

### 4.3 매매 실행 로직

#### 4.3.1 매도 단계
1. **초과 비중 자산 식별**
   - 현재 비율 > 목표 비율인 모든 ETF
   - 편차가 임계값 이상인 것만 선별

2. **매도 금액 계산**
   ```
   매도 금액 = (현재 평가금액 - 목표 금액) × (1 - 거래 비용률)
   ```

3. **매도 수량 계산**
   ```
   매도 수량 = floor(매도 금액 / 현재가)
   ```

4. **매도 실행**
   - KIS API `sell_market_order(ticker, quantity)` 호출
   - 체결 확인 대기
   - 실패 시 재시도 또는 다음 자산으로 이동

5. **특수 케이스 처리**
   - **Alternatives 자산군**: 금과 달러의 비율(7:3 또는 8:2)을 유지하며 매도
   - **Stocks 자산군**: S&P500, 나스닥, KOSPI의 비율(1:1:1 또는 Sub-MP 비율)을 유지하며 매도

#### 4.3.2 매수 단계
1. **부족 비중 자산 식별**
   - 현재 비율 < 목표 비율인 모든 ETF
   - 편차가 임계값 이상인 것만 선별

2. **사용 가능 현금 계산**
   ```
   사용 가능 현금 = 현재 현금 - (총 평가금액 × 현금 보유 비율)
   ```
   - 현금 보유 비율: 기본 3% (cash_reserve_ratio)

3. **매수 금액 계산**
   ```
   매수 금액 = min(목표 금액 - 현재 평가금액, 사용 가능 현금 × 할당 비율)
   ```

4. **매수 수량 계산**
   ```
   매수 수량 = floor(매수 금액 / 현재가)
   ```

5. **매수 실행**
   - KIS API `get_current_price(ticker)` 호출하여 최신 가격 확인
   - KIS API `buy_market_order(ticker, quantity)` 호출
   - 체결 확인 대기
   - 실패 시 재시도 또는 다음 자산으로 이동

6. **특수 케이스 처리**
   - **Stocks 자산군**: Sub-MP 비율에 따라 S&P500, 나스닥, 배당주/KOSPI 비율 유지하며 매수
   - **Alternatives 자산군**: Sub-MP 비율에 따라 금과 달러 비율 유지하며 매수

#### 4.3.3 실행 순서 제어
1. **순차 실행**: 매도 완료 후 매수 시작 (동시 매매 방지)
2. **자산군별 그룹핑**: 같은 자산군 내 ETF는 함께 처리
3. **우선순위 기반**: 편차가 큰 자산부터 우선 처리

### 4.4 거래 비용 고려

#### 4.4.1 거래 비용 구성
1. **매매 수수료**: 거래 금액 × 0.015%
2. **세금**: 양도소득세 등 (매도 시 발생)
3. **스프레드**: 시장가 주문 시 발생하는 매수/매도 가격 차이

#### 4.4.2 거래 비용 계산
```
총 거래 비용 = (매도 금액 × 수수료율) + (매수 금액 × 수수료율) + 세금
```

#### 4.4.3 거래 비용 검증
1. **비용 대비 편차 검증**
   ```
   예상 수익 = 편차 감소로 인한 포트폴리오 최적화 효과
   ```
   - 거래 비용이 예상 수익보다 크면 리밸런싱 취소

2. **임계값 검증**
   - 거래 비용이 총 자산의 5%를 초과하면 리밸런싱 취소
   - 작은 편차 조정으로 인한 과도한 거래 비용 방지

#### 4.4.4 비용 최적화 전략
- 부분 리밸런싱: 편차가 큰 자산만 우선 조정
- 배치 처리: 여러 ETF를 한 번에 처리하여 수수료 절감
- 최소 거래 금액: 설정된 최소 거래 금액(기본 100,000원) 미만은 매매하지 않음

---

## 5. 한국투자증권 API 활용

### 5.1 필요한 API 기능

#### 5.1.1 계좌 정보 조회
- **API**: `get_balance()`
- **용도**: 현재 보유 종목, 수량, 평가금액, 현금 잔고 조회
- **호출 시점**: 리밸런싱 시작 전, 매매 후 확인

#### 5.1.2 현재가 조회
- **API**: `get_current_price(ticker)`
- **용도**: 매매 수량 계산을 위한 최신 가격 확인
- **호출 시점**: 매매 전 각 종목별 가격 확인

#### 5.1.3 매수 주문
- **API**: `buy_market_order(ticker, quantity)`
- **용도**: 시장가 매수 주문 실행
- **응답 처리**: 주문 성공/실패 확인, 주문 번호 저장

#### 5.1.4 매도 주문
- **API**: `sell_market_order(ticker, quantity)`
- **용도**: 시장가 매도 주문 실행
- **응답 처리**: 주문 성공/실패 확인, 주문 번호 저장

### 5.2 API 호출 제약사항
- **Rate Limiting**: API 호출 간 최소 0.1초 대기 (time.sleep(0.1))
- **토큰 관리**: 액세스 토큰 자동 갱신 및 파일 캐싱
- **에러 처리**: API 호출 실패 시 재시도 로직 또는 예외 처리

### 5.3 주문 체결 확인
- 주문 후 일정 시간 대기하여 체결 여부 확인
- 미체결 시 재시도 또는 다음 단계로 진행
- 체결 내역을 데이터베이스에 기록

---

## 6. 실행 조건 및 제약사항

### 6.1 실행 시간
- **기본 실행 시간**: 매일 15:00 KST (장 마감 직전)
- **장 운영 시간**: 09:00 ~ 15:30 KST
- **실행 시간 검증**: 장 운영 시간 내에만 리밸런싱 실행

### 6.2 공휴일/휴장일 확인
- 한국 증시 휴장일 체크
- 공휴일에는 리밸런싱 실행하지 않음
- 다음 거래일로 자동 연기

### 6.3 긴급 중지 플래그
- 설정 파일 또는 데이터베이스에 긴급 중지 플래그 확인
- 플래그가 활성화되어 있으면 리밸런싱 실행하지 않음
- 수동 개입이 필요한 상황 대응

### 6.4 Dry Run 모드
- 실제 매매 없이 시뮬레이션만 수행
- 매매 계획을 로그로 출력
- 테스트 및 검증 목적으로 활용

### 6.5 최소 거래 금액
- 설정된 최소 거래 금액(기본 100,000원) 미만은 매매하지 않음
- 작은 금액의 불필요한 거래 방지

---

## 7. 안전장치 및 예외 처리

### 7.1 리스크 관리

#### 7.1.1 일일 손실 제한
- 일일 손실이 총 자산의 5%를 초과하면 리밸런싱 중단
- 급격한 시장 변동 시 자산 보호

#### 7.1.2 월간 손실 제한
- 월간 손실이 총 자산의 15%를 초과하면 리밸런싱 중단
- 장기적인 손실 누적 방지

#### 7.1.3 수동 승인 모드
- `manual_approval_required` 설정이 활성화되면 매매 전 수동 승인 필요
- 중요한 매매 결정에 대한 추가 검증

### 7.2 예외 상황 처리

#### 7.2.1 API 호출 실패
- 네트워크 오류, 인증 실패 등
- 재시도 로직 적용 (최대 3회)
- 실패 시 로그 기록 및 알림

#### 7.2.2 주문 체결 실패
- 시장가 주문이 체결되지 않는 경우
- 다음 거래일로 연기 또는 부분 체결 처리

#### 7.2.3 데이터 불일치
- 목표 비율과 현재 비율 계산 결과가 비정상적인 경우
- 리밸런싱 중단 및 로그 기록

#### 7.2.4 현금 부족
- 매수에 필요한 현금이 부족한 경우
- 매도 우선 실행 후 현금 확보
- 여전히 부족하면 부분 매수만 실행

### 7.3 로깅 및 모니터링
- 모든 리밸런싱 실행 이력을 데이터베이스에 저장
- 실행 전/후 포트폴리오 상태 기록
- 매매 내역 상세 기록
- 에러 및 예외 상황 로그 기록

---

## 8. 실행 이력 관리

### 8.1 저장 정보
- 실행 일시
- 선택된 MP 및 Sub-MP
- 실행 전 포트폴리오 상태 (자산군별 비율, 평가금액)
- 실행 후 포트폴리오 상태
- 매매 내역 (종목, 수량, 가격, 거래 비용)
- 편차 변화량
- 실행 결과 (성공/실패, 에러 메시지)

### 8.2 데이터베이스 스키마
- `rebalancing_history` 테이블에 저장
- 실행 이력을 통한 성과 분석 및 최적화

---

## 9. 알고리즘 최적화 고려사항

### 9.1 편차 임계값 최적화
- 기본값: 5%
- 시장 상황에 따라 동적 조정 가능
- 거래 비용과 편차 감소 효과의 균형

### 9.2 현금 보유 비율 최적화
- 기본값: 3%
- 유동성 확보와 투자 효율의 균형
- 시장 변동성에 따른 동적 조정 가능

### 9.3 부분 리밸런싱 전략
- 전체 리밸런싱 vs 부분 리밸런싱
- 거래 비용 최소화를 위한 점진적 접근
- 편차가 큰 자산 우선 처리

### 9.4 실행 빈도 최적화
- 매일 실행 vs 주간 실행
- 시장 변동성에 따른 동적 조정
- 거래 비용과 포트폴리오 최적화 효과의 균형

---

## 10. 향후 개선 방향

### 10.1 동적 임계값 조정
- 시장 변동성에 따라 임계값 자동 조정
- 거래 비용과 편차 감소 효과의 실시간 균형

### 10.2 예측 기반 리밸런싱
- 시장 예측을 통한 선제적 리밸런싱
- 변동성 예측 모델 통합

### 10.3 다중 계좌 지원
- 여러 계좌에 대한 동시 리밸런싱
- 계좌별 전략 차별화

### 10.4 백테스팅 통합
- 과거 데이터를 통한 리밸런싱 전략 검증
- 최적 파라미터 탐색

---

## 11. 참고 사항

### 11.1 설정 파일 구조
- `macro_trading_config.json`에 모든 설정값 저장
- 리밸런싱 임계값, 실행 시간, ETF 매핑 등

### 11.2 MP 및 Sub-MP 정의
- `ai_strategist.py`에 MP 및 Sub-MP 구조 정의
- 새로운 MP/Sub-MP 추가 시 해당 파일 수정

### 11.3 한국투자증권 API 문서
- 실전투자와 모의투자의 TR_ID 차이 확인
- API 응답 구조 및 에러 코드 파악

---

## 12. 용어 정리

- **MP (Model Portfolio)**: 전체 포트폴리오의 자산군별 배분 비율을 정의하는 모델
- **Sub-MP (Sub Model Portfolio)**: 각 자산군 내에서 세부 ETF 배분을 정의하는 모델
- **편차 (Deviation)**: 목표 비율과 현재 비율의 차이
- **임계값 (Threshold)**: 리밸런싱을 실행하기 위한 최소 편차 기준
- **부분 리밸런싱 (Partial Rebalancing)**: 모든 자산을 조정하지 않고 편차가 큰 자산만 우선 처리하는 전략
- **Dry Run**: 실제 매매 없이 시뮬레이션만 수행하는 모드

---

**문서 버전**: 1.0  
**작성일**: 2024년  
**최종 수정일**: 2024년

