// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ORITUBE

//@version=6
strategy("이동평균선 정배열 (PRD)", overlay=true, initial_capital=1000000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, calc_on_every_tick=false)

// Date Filter
start = input.time(timestamp("2017-04-14"), "Start", group="Date Filter")
finish = input.time(timestamp("2025-07-14"), "End", group="Date Filter")

date_filter = time >= start and time <= finish ? true : false


// ema variable set
ema1 = ta.ema(close, 7)
ema2 = ta.ema(close, 20)
ema3 = ta.ema(close, 99)
ema4 = ta.ema(close, 180)


//plot ema
plot(ema1, color = color.rgb(81, 209, 30))
plot(ema2, color = color.rgb(92, 104, 51))
plot(ema3, color = color.rgb(44, 16, 199))
plot(ema4, color = color.rgb(0, 0, 0))

/// ------------------------------
// * atr
// ------------------------------
atr = ta.atr(14)

// ------------------------------
// * Bollinger Plot
// ------------------------------
[bbMiddle, bbUpper, bbLower] = ta.bb (close, 20, 1)

bbLowerPlot = plot(bbLower, "Lower", color=color.rgb(121, 119, 119, 76))
bbUpperPlot = plot(bbUpper, "Lower", color=color.rgb(121, 119, 119, 79))

// ------------------------------
// * Strategy1: ema Strategy
// ------------------------------

[bbMiddle_st1, bbUpper_st1, bbLower_st1] = ta.bb (close, 20, 2)
bbLower2Plot = plot(bbLower_st1, "Lower", color=color.rgb(121, 119, 119, 76))
bbUpper2Plot = plot(bbUpper_st1, "Lower", color=color.rgb(121, 119, 119, 79))

rsi = ta.rsi(close, 14)
rsi_ma2 = ta.ema(rsi,2)
rsi_ma4 = ta.ema(rsi,4)

ema_almost_crossunder = math.abs(ema1-ema2) * 100/ema1 < 0.5

longCondition_ema =  ( ema1 > ema2 and ema2 > ema3 and ema3 > ema4 )// and (ema1[1] < ema2[1])
sellCondition_ema = not(ema1 > ema2 and ema2 > ema3 and ema3 > ema4)// or ema_almost_crossunder //or bbUpper_st1 < close


almostCrossunder = ema3 > ema4 and ema_almost_crossunder

// ------------------------------
// * Strategy2: ema Strategy
// ------------------------------
sell_each_condition = ta.crossunder(close, bbLower_st1)
sell_each_condition2 = ta.crossunder(ema1, ema2)

longCondition_ema2 = ta.crossover(ema1, ema2) and ema4 > ema3 and ema3 > ema2
sellCondition_ema2 = ta.crossover(close, ema3) or sell_each_condition or sell_each_condition2

// ------------------------------
// * Strategy3: bb, rsi
// ------------------------------
//매수조건1: rsi ema cross over
rsi_crossover = rsi_ma2 > rsi_ma4//ta.crossover(rsi_ma2, rsi_ma4)

//1-2 test
use_almost_strategy = input.bool(title = "use_almost_strategy", defval = true)
threshold = input.float(title = "1-2/threshold", defval = 1.8 )

rsi_almost_crossover = false
if use_almost_strategy
    rsi_almost_crossover := math.abs(rsi-rsi_ma2) * 100 / rsi < threshold and math.abs(rsi-rsi_ma4) * 100 / rsi_ma4 < threshold and math.abs(rsi_ma2-rsi_ma4) * 100 / rsi_ma2 < threshold

//매수조건2: rsi가 역배열 상태였는지 체크
rsi_before2_crossover = rsi[1] < rsi_ma4[1] and rsi_ma2[1] < rsi_ma4[1]
rsi_before3_crossover = rsi[2] < rsi_ma4[2] and rsi_ma2[2] < rsi_ma4[2]

condition_rsi_before = rsi_before2_crossover or rsi_before3_crossover

//매수조건3: 직전 low price들이 bb Lower에 위치했었는지
bbLowerAroundUnder =  bbLower[3] > low[3] or bbLower[2] > low[2] or bbLower[1] > low[1] or bbLower > low //ta.crossunder(close, bbLower)

//매수조건4: 직전 close가 ema1 위에 있는지?
close_over_ema1 = close > ema1
close_under_ema1 = close < ema1

//매수조건5: 매수 조건 다 맞을때, rsi 오목하게 올라오는지 체크
rsi_omok = rsi > rsi[1] or rsi[1] > rsi[2]


//매도조건-bbrsi: low가 bbLower_st1 밑에있는지 
bbrsi_close_bbLower_st1 = low < bbLower_st1
bbrsi_close_bbLower = low < bbLower

//bbrsi_under 조건
longCondition_bbrsi_under = (rsi_crossover or rsi_almost_crossover) and bbLowerAroundUnder and close_under_ema1 and condition_rsi_before and rsi_omok
closeCondition_bbrsi_under = ta.crossover(close, ema1) or bbrsi_close_bbLower_st1

//bbrsi_over 조건
longCondition_bbrsi_over = (rsi_crossover or rsi_almost_crossover) and bbLowerAroundUnder and close_over_ema1 and condition_rsi_before and rsi_omok
closeCondition_bbrsi_over = ta.crossover(close, bbUpper) or bbrsi_close_bbLower_st1

// ------------------------------
// * Strategy4: morning star
// ------------------------------

// 급락 조건 설정
sharp_decline_period = input.int(2, "급락 확인 기간", minval=1, maxval=20, group="Strategy4")
sharp_decline_multiplier = input.float(1.5, "급락 배수", minval=0.5, maxval=3.0, group="Strategy4")
consecutive_decline_period = input.int(3, "연속 하락 기간", minval=2, maxval=10, group="Strategy4")
bb_touch_period = input.int(3, "BB 하단 터치 확인 기간", minval=1, maxval=10, group="Strategy4")

// 도지 캔들 조건
find_morning_star = math.abs(close-open)/close < 0.004

// 급락 조건: 최근 기간 중 ATR의 배수 이상 하락한 봉이 있는지
has_sharp_decline = false
for i = 0 to sharp_decline_period - 1
    if (close[i] - low[i]) >= atr[i] * sharp_decline_multiplier
        has_sharp_decline := true
        break

// 연속 하락 조건: 최근 몇 개 봉이 연속으로 하락했는지 확인
consecutive_decline_count = 0
for i = 1 to consecutive_decline_period
    if close[i] < close[i-1]
        consecutive_decline_count += 1
    else
        break

has_consecutive_decline = consecutive_decline_count >= consecutive_decline_period

// 볼린저 밴드 하단 터치 조건
has_bb_lower_touch = false
for i = 0 to bb_touch_period - 1
    if low[i] <= bbLower[i] or close[i] <= bbLower[i]
        has_bb_lower_touch := true
        break

// 추가 급락 조건: 연속 하락과 BB 하단 터치도 함께 만족해야 함
has_additional_decline = has_consecutive_decline and has_bb_lower_touch

// 최종 급락 조건: 기본 급락 또는 추가 조건 모두 만족
final_sharp_decline = has_sharp_decline or has_additional_decline

// 기존 조건들
ema_morning_star = ema1 < ema3
bbLowerAroundUnder_st1 = bbLower_st1[3] > low[3] or bbLower_st1[2] > low[2] or bbLower_st1[1] > low[1] or bbLower_st1 > low 

// 급락 조건을 포함한 매수 조건 (급락 조건을 필수로 변경)
longCondition_morning_star = ema_morning_star and bbLowerAroundUnder_st1 and find_morning_star and final_sharp_decline
closeCondition_morning_star = ta.crossover(close, bbUpper) or bbrsi_close_bbLower_st1


// ------------------------------
// Final Entry Condition Setting
// ------------------------------
entryLongCondition = longCondition_ema and date_filter
closeCondition = sellCondition_ema and date_filter
almostCloseCondition = almostCrossunder and date_filter
overBBCondition = close > bbUpper_st1 and date_filter

entryLongCondition_ema2 = longCondition_ema2 and date_filter
closeCondition_ema2 = sellCondition_ema2 and date_filter

entryLongCondition_bbrsi_under = longCondition_bbrsi_under and date_filter and not(closeCondition_bbrsi_under)
entryExitCondition_bbrsi_under = closeCondition_bbrsi_under and date_filter

entryLongCondition_bbrsi_over = longCondition_bbrsi_over and date_filter and not(closeCondition_bbrsi_over)
entryExitCondition_bbrsi_over = closeCondition_bbrsi_over and date_filter
u
entryLongCondition_morning_star = longCondition_morning_star and date_filter
entryExitCondition_morning_star = closeCondition_morning_star and date_filter



use_ema_strategy = input.bool(title = "ema", defval = true)
if use_ema_strategy
    if closeCondition or almostCloseCondition
        strategy.close("ema")

    else
        if entryLongCondition
            strategy.entry("ema", strategy.long)
        
    // if overBBCondition
    //     strategy.exit(id = "Exit_ema", from_entry = "Long_ema", limit = high + atr*2)
    // strategy.exit(id = "Exit_ema", from_entry = "Long_ema", stop = open * 0.90)    

use_ema_strategy2 = input.bool(title = "ema2", defval = true)
if use_ema_strategy2
    if entryLongCondition_ema2
        strategy.entry("ema2", strategy.long)
    //strategy.exit(id = "Exit_ema2", from_entry = "Long_ema2", limit = high + atr*2, stop = close - atr*1)

    if closeCondition_ema2
        strategy.close("ema2")
// -----------------------------------------------------------------
use_bbrsi_strategy_under = input.bool(title = "bbrsi_strategy_under", defval = true)
if use_bbrsi_strategy_under
    if entryLongCondition_bbrsi_under
        strategy.entry("bu", strategy.long)

    if entryExitCondition_bbrsi_under
        strategy.close("bu")
        
    strategy.exit(id="Exit_bbrsi_under", from_entry = "bu", stop = close*0.88)

// -----------------------------------------------------------------
use_bbrsi_strategy_over = input.bool(title = "bbrsi_strategy_over", defval = true)
if use_bbrsi_strategy_over
    if entryLongCondition_bbrsi_over
        strategy.entry("bo", strategy.long)
        //strategy.exit(id="Long_bbrsi_over", stop = low - atr*1)

    if entryExitCondition_bbrsi_over
        strategy.close("bo")

    strategy.exit(id="Exit_bbrsi_over", from_entry = "bo", limit = high + atr*4, stop = low - atr*1)

    // if bbrsi_close_bbLower_st1
    //     strategy.exit("Exit over", from_entry ="Long_bbrsi_over", stop = open * 0.95)

// -----------------------------------------------------------------
use_morning_star_strategy = input.bool(title = "ms", defval = true)
if use_morning_star_strategy
    if entryLongCondition_morning_star
        strategy.entry("ms", strategy.long)

    strategy.exit(id="Exit_ms", from_entry = "ms", limit = high + atr*4, stop = low - atr*1)

// -------------------------------
// text display
// -------------------------------
textbox_useflag = input.bool(title = "textbox 사용",defval = false)

if textbox_useflag
    var table rsiDisplay = table.new(position.top_right, 1, 31)


        // We only populate the table on the last bar.
    table.cell(rsiDisplay, 0, 0, "atr: " + str.tostring(atr), bgcolor = color.blue)
    table.cell(rsiDisplay, 0, 1, "rsi_ma2(-1): " + str.tostring(rsi_ma2), bgcolor = color.blue)
    table.cell(rsiDisplay, 0, 2, "rsi_ma4(-1): " + str.tostring(rsi_ma4), bgcolor = color.blue)

    table.cell(rsiDisplay, 0, 4, "bbLower(-1): " + str.tostring(bbLower), bgcolor = color.rgb(39, 141, 8))
    table.cell(rsiDisplay, 0, 5, "bbLower(-2): " + str.tostring(bbLower[1]), bgcolor = color.rgb(39, 141, 8))
    table.cell(rsiDisplay, 0, 6, "bbLower(-3): " + str.tostring(bbLower[2]), bgcolor = color.rgb(39, 141, 8))
    table.cell(rsiDisplay, 0, 7, "bbLower(-4): " + str.tostring(bbLower[3]), bgcolor = color.rgb(39, 141, 8))
    table.cell(rsiDisplay, 0, 8, "ema_almost_crossunder: " + str.tostring(math.abs(ema1-ema2) * 100/ema1), bgcolor = color.rgb(39, 141, 8))

    table.cell(rsiDisplay, 0, 9, "close(-1): " + str.tostring(close), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 10, "close(-2): " + str.tostring(close[1]), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 11, "close(-3): " + str.tostring(close[2]), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 12, "close(-4): " + str.tostring(close[3]), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 13, "close(-5): " + str.tostring(close[4]), bgcolor = color.rgb(48, 139, 185))

    table.cell(rsiDisplay, 0, 14, "low(-1): " + str.tostring(low), bgcolor = color.rgb(48, 185, 94))
    table.cell(rsiDisplay, 0, 15, "low(-2): " + str.tostring(low[1]), bgcolor = color.rgb(48, 185, 94))
    table.cell(rsiDisplay, 0, 16, "low(-3): " + str.tostring(low[2]), bgcolor = color.rgb(48, 185, 94))
    table.cell(rsiDisplay, 0, 17, "low(-4): " + str.tostring(low[3]), bgcolor = color.rgb(48, 185, 94))
    table.cell(rsiDisplay, 0, 18, "low(-5): " + str.tostring(low[4]), bgcolor = color.rgb(48, 185, 94))

    table.cell(rsiDisplay, 0, 19, "ma7: " + str.tostring(ema1), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 20, "ma20: " + str.tostring(ema2), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 21, "ma99: " + str.tostring(ema3), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 22, "ma180: " + str.tostring(ema4), bgcolor = color.rgb(48, 139, 185))

    table.cell(rsiDisplay, 0, 23, "rsi(-2): " + str.tostring(rsi[1]), bgcolor = color.blue)
    table.cell(rsiDisplay, 0, 24, "rsi_ma2(-2): " + str.tostring(rsi_ma2[1]), bgcolor = color.blue)
    table.cell(rsiDisplay, 0, 25, "rsi_ma4(-2): " + str.tostring(rsi_ma4[1]), bgcolor = color.blue)

    table.cell(rsiDisplay, 0, 26, "bbLower_st1: " + str.tostring(bbLower_st1), bgcolor = color.blue)
    
    // Strategy4 디버깅 정보
    table.cell(rsiDisplay, 0, 27, "has_sharp_decline: " + str.tostring(has_sharp_decline), bgcolor = color.yellow)
    table.cell(rsiDisplay, 0, 28, "has_consecutive_decline: " + str.tostring(has_consecutive_decline), bgcolor = color.yellow)
    table.cell(rsiDisplay, 0, 29, "has_bb_lower_touch: " + str.tostring(has_bb_lower_touch), bgcolor = color.yellow)
    table.cell(rsiDisplay, 0, 30, "find_morning_star: " + str.tostring(find_morning_star), bgcolor = color.yellow)
    