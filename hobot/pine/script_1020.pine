// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ORITUBE

//@version=6
strategy("이동평균선 정배열 (PRD) - Split Strategy", overlay=true, initial_capital=1000000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, calc_on_every_tick=false, pyramiding=5)

// Date Filter
start = input.time(timestamp("2017-04-14"), "Start", group="Date Filter")
finish = input.time(timestamp("2025-07-14"), "End", group="Date Filter")

date_filter = time >= start and time <= finish ? true : false


// ema variable set
ema1 = ta.ema(close, 7)
ema2 = ta.ema(close, 20)
ema3 = ta.ema(close, 99)
ema4 = ta.ema(close, 180)


//plot ema
plot(ema1, color = color.rgb(81, 209, 30))
plot(ema2, color = color.rgb(92, 104, 51))
plot(ema3, color = color.rgb(44, 16, 199))
plot(ema4, color = color.rgb(0, 0, 0))

/// ------------------------------
// * atr
// ------------------------------
atr = ta.atr(14)
atr_multiplier = input.float(2.0, "ATR Multiplier", group="Risk Management")

// ------------------------------
// * Bollinger Plot
// ------------------------------
[bbMiddle, bbUpper, bbLower] = ta.bb (close, 20, 1)

bbLowerPlot = plot(bbLower, "Lower", color=color.rgb(121, 119, 119, 76))
bbUpperPlot = plot(bbUpper, "Lower", color=color.rgb(121, 119, 119, 79))

// ------------------------------
// * Strategy1: ema Strategy
// ------------------------------

[bbMiddle_st1, bbUpper_st1, bbLower_st1] = ta.bb (close, 20, 2)
bbLower2Plot = plot(bbLower_st1, "Lower", color=color.rgb(121, 119, 119, 76))
bbUpper2Plot = plot(bbUpper_st1, "Lower", color=color.rgb(121, 119, 119, 79))

rsi = ta.rsi(close, 14)
rsi_ma2 = ta.ema(rsi,2)
rsi_ma4 = ta.ema(rsi,4)

ema_almost_crossunder = math.abs(ema1-ema2) * 100/ema1 < 0.5

longCondition_ema =  ( ema1 > ema2 and ema2 > ema3 and ema3 > ema4 )// and (ema1[1] < ema2[1])
sellCondition_ema = not(ema1 > ema2 and ema2 > ema3 and ema3 > ema4)// or ema_almost_crossunder //or bbUpper_st1 < close


almostCrossunder = ema3 > ema4 and ema_almost_crossunder

// ------------------------------
// * Strategy2: ema Strategy
// ------------------------------
sell_each_condition = ta.crossunder(close, bbLower_st1)
sell_each_condition2 = ta.crossunder(ema1, ema2)

longCondition_ema2 = ta.crossover(ema1, ema2) and ema4 > ema3 and ema3 > ema2
sellCondition_ema2 = ta.crossover(close, ema3) or sell_each_condition or sell_each_condition2

// ------------------------------
// * Strategy3: bb, rsi
// ------------------------------
//매수조건1: rsi ema cross over
rsi_crossover = rsi_ma2 > rsi_ma4//ta.crossover(rsi_ma2, rsi_ma4)

//1-2 test
use_almost_strategy = input.bool(title = "use_almost_strategy", defval = true)
threshold = input.float(title = "1-2/threshold", defval = 1.8 )

rsi_almost_crossover = false
if use_almost_strategy
    rsi_almost_crossover := math.abs(rsi-rsi_ma2) * 100 / rsi < threshold and math.abs(rsi-rsi_ma4) * 100 / rsi_ma4 < threshold and math.abs(rsi_ma2-rsi_ma4) * 100 / rsi_ma2 < threshold

//매수조건2: rsi가 역배열 상태였는지 체크
rsi_before2_crossover = rsi[1] < rsi_ma4[1] and rsi_ma2[1] < rsi_ma4[1]
rsi_before3_crossover = rsi[2] < rsi_ma4[2] and rsi_ma2[2] < rsi_ma4[2]

condition_rsi_before = rsi_before2_crossover or rsi_before3_crossover

//매수조건3: 직전 low price들이 bb Lower에 위치했었는지
bbLowerAroundUnder =  bbLower[3] > low[3] or bbLower[2] > low[2] or bbLower[1] > low[1] or bbLower > low //ta.crossunder(close, bbLower)

//매수조건4: 직전 close가 ema1 위에 있는지?
close_over_ema1 = close > ema1
close_under_ema1 = close < ema1

//매수조건5: 매수 조건 다 맞을때, rsi 오목하게 올라오는지 체크
rsi_omok = rsi > rsi[1] or rsi[1] > rsi[2]


//매도조건-bbrsi: low가 bbLower_st1 밑에있는지 
bbrsi_close_bbLower_st1 = low < bbLower_st1
bbrsi_close_bbLower = low < bbLower

//bbrsi_under 조건
longCondition_bbrsi_under = (rsi_crossover or rsi_almost_crossover) and bbLowerAroundUnder and close_under_ema1 and condition_rsi_before and rsi_omok
closeCondition_bbrsi_under = ta.crossover(close, ema1) or bbrsi_close_bbLower_st1

//bbrsi_over 조건
longCondition_bbrsi_over = (rsi_crossover or rsi_almost_crossover) and bbLowerAroundUnder and close_over_ema1 and condition_rsi_before and rsi_omok
closeCondition_bbrsi_over = ta.crossover(close, bbUpper) or bbrsi_close_bbLower_st1


// ------------------------------
// Final Entry Condition Setting
// ------------------------------
entryLongCondition = longCondition_ema and date_filter
// closeCondition = sellCondition_ema and date_filter
// almostCloseCondition = almostCrossunder and date_filter
// overBBCondition = close > bbUpper_st1 and date_filter

entryLongCondition_ema2 = longCondition_ema2 and date_filter
closeCondition_ema2 = sellCondition_ema2 and date_filter

entryLongCondition_bbrsi_under = longCondition_bbrsi_under and date_filter and not(closeCondition_bbrsi_under)
entryExitCondition_bbrsi_under = closeCondition_bbrsi_under and date_filter

entryLongCondition_bbrsi_over = longCondition_bbrsi_over and date_filter and not(closeCondition_bbrsi_over)
entryExitCondition_bbrsi_over = closeCondition_bbrsi_over and date_filter


// ==============================================================================
// EXECUTION BLOCKS
// ==============================================================================

// Helper: Calculate Qty based on % of Equity
get_qty_pct(pct) =>
    (strategy.equity * (pct / 100)) / close

// -----------------------------------------------------------------
// STRATEGY 1: EMA (Pyramiding)
// -----------------------------------------------------------------
use_ema_strategy = input.bool(title = "ema", defval = true)

if use_ema_strategy
    // Entry 1: 30% Initial
    if entryLongCondition and strategy.position_size == 0
        strategy.entry("EMA_Ent1", strategy.long, qty=get_qty_pct(30))
    
    // Pyramiding Logic (Only if EMA position is active)
    // Check if latest entry was EMA
    is_ema_active = (strategy.opentrades > 0) and str.contains(strategy.opentrades.entry_id(strategy.opentrades - 1), "EMA")
    
    if is_ema_active
        avg_price = strategy.position_avg_price
        
        // Entry 2: +1% Rise (30%)
        if close > avg_price * 1.01 and strategy.opentrades == 1
            strategy.entry("EMA_Ent2", strategy.long, qty=get_qty_pct(30))
            
        // Entry 3: +2% Rise (40%)
        if close > avg_price * 1.02 and strategy.opentrades == 2
            strategy.entry("EMA_Ent3", strategy.long, qty=get_qty_pct(40))
    
    // Exit Logic
    if sellCondition_ema
        strategy.close_all(comment="EMA_Exit_Signal")
        
    // Dynamic Stop Loss (ATR)
    if is_ema_active
        strategy.exit("EMA_SL", stop = close - atr * atr_multiplier)


// -----------------------------------------------------------------
// STRATEGY 2: EMA2 (Scale-Out)
// -----------------------------------------------------------------
use_ema_strategy2 = input.bool(title = "ema2", defval = true)

if use_ema_strategy2
    // Entry: 50% only (Risk Control)
    if entryLongCondition_ema2 and strategy.position_size == 0
        strategy.entry("EMA2_Ent", strategy.long, qty=get_qty_pct(50))

    // Scale Out 1: 50% Exit at +3% Profit
    strategy.exit("EMA2_TP1", "EMA2_Ent", qty_percent=50, profit=3) // profit is in ticks? No, checks strategy settings.
    // Assuming standard crypto pair where 1 tick = min move. Safer to use limit.
    // strategy.exit("EMA2_TP1", "EMA2_Ent", qty_percent=50, limit=strategy.position_avg_price * 1.03)
    // Note: position_avg_price is only valid during the trade.
    
    // Full Exit condition
    if closeCondition_ema2
        strategy.close("EMA2_Ent", comment="EMA2_Signal_Close")


// -----------------------------------------------------------------
// STRATEGY 3 & 4: BB RSI (Single Entry)
// -----------------------------------------------------------------
use_bbrsi_strategy_under = input.bool(title = "bbrsi_strategy_under", defval = true)
use_bbrsi_strategy_over = input.bool(title = "bbrsi_strategy_over", defval = true)

// UNDER Mode
if use_bbrsi_strategy_under
    // Entry: 100% Entry (No DCA)
    if entryLongCondition_bbrsi_under and strategy.position_size == 0
        strategy.entry("BBRUI_Ent", strategy.long, qty=get_qty_pct(100))

    // Exit
    if entryExitCondition_bbrsi_under
        strategy.close("BBRUI_Ent", comment="BBRUI_Close")
    
    // Hard Stop
    strategy.exit("BBRUI_SL", "BBRUI_Ent", stop = strategy.position_avg_price * 0.88)


// OVER Mode
if use_bbrsi_strategy_over
    // Entry: 100% Entry
    if entryLongCondition_bbrsi_over and strategy.position_size == 0
        strategy.entry("BBRO_Ent", strategy.long, qty=get_qty_pct(100))

    // Exit
    if entryExitCondition_bbrsi_over
        strategy.close("BBRO_Ent", comment="BBRO_Close")
        
    // Dynamic Stop
    strategy.exit("BBRO_Exit", "BBRO_Ent", limit = high + atr*4, stop = low - atr*1)


// -------------------------------
// text display
// -------------------------------
textbox_useflag = input.bool(title = "textbox 사용",defval = false)

if textbox_useflag
    var table rsiDisplay = table.new(position.top_right, 1, 31)


        // We only populate the table on the last bar.
    table.cell(rsiDisplay, 0, 0, "atr: " + str.tostring(atr), bgcolor = color.blue)
    table.cell(rsiDisplay, 0, 1, "rsi_ma2(-1): " + str.tostring(rsi_ma2), bgcolor = color.blue)
    table.cell(rsiDisplay, 0, 2, "rsi_ma4(-1): " + str.tostring(rsi_ma4), bgcolor = color.blue)

    table.cell(rsiDisplay, 0, 4, "bbLower(-1): " + str.tostring(bbLower), bgcolor = color.rgb(39, 141, 8))
    table.cell(rsiDisplay, 0, 5, "bbLower(-2): " + str.tostring(bbLower[1]), bgcolor = color.rgb(39, 141, 8))
    table.cell(rsiDisplay, 0, 6, "bbLower(-3): " + str.tostring(bbLower[2]), bgcolor = color.rgb(39, 141, 8))
    table.cell(rsiDisplay, 0, 7, "bbLower(-4): " + str.tostring(bbLower[3]), bgcolor = color.rgb(39, 141, 8))
    table.cell(rsiDisplay, 0, 8, "ema_almost_crossunder: " + str.tostring(math.abs(ema1-ema2) * 100/ema1), bgcolor = color.rgb(39, 141, 8))

    table.cell(rsiDisplay, 0, 9, "close(-1): " + str.tostring(close), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 10, "close(-2): " + str.tostring(close[1]), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 11, "close(-3): " + str.tostring(close[2]), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 12, "close(-4): " + str.tostring(close[3]), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 13, "close(-5): " + str.tostring(close[4]), bgcolor = color.rgb(48, 139, 185))

    table.cell(rsiDisplay, 0, 14, "low(-1): " + str.tostring(low), bgcolor = color.rgb(48, 185, 94))
    table.cell(rsiDisplay, 0, 15, "low(-2): " + str.tostring(low[1]), bgcolor = color.rgb(48, 185, 94))
    table.cell(rsiDisplay, 0, 16, "low(-3): " + str.tostring(low[2]), bgcolor = color.rgb(48, 185, 94))
    table.cell(rsiDisplay, 0, 17, "low(-4): " + str.tostring(low[3]), bgcolor = color.rgb(48, 185, 94))
    table.cell(rsiDisplay, 0, 18, "low(-5): " + str.tostring(low[4]), bgcolor = color.rgb(48, 185, 94))

    table.cell(rsiDisplay, 0, 19, "ma7: " + str.tostring(ema1), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 20, "ma20: " + str.tostring(ema2), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 21, "ma99: " + str.tostring(ema3), bgcolor = color.rgb(48, 139, 185))
    table.cell(rsiDisplay, 0, 22, "ma180: " + str.tostring(ema4), bgcolor = color.rgb(48, 139, 185))

    table.cell(rsiDisplay, 0, 23, "rsi(-2): " + str.tostring(rsi[1]), bgcolor = color.blue)
    table.cell(rsiDisplay, 0, 24, "rsi_ma2(-2): " + str.tostring(rsi_ma2[1]), bgcolor = color.blue)
    table.cell(rsiDisplay, 0, 25, "rsi_ma4(-2): " + str.tostring(rsi_ma4[1]), bgcolor = color.blue)

    table.cell(rsiDisplay, 0, 26, "bbLower_st1: " + str.tostring(bbLower_st1), bgcolor = color.blue)