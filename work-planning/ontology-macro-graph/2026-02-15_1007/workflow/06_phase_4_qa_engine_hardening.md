# Phase 4 상세 계획: QA 엔진 고도화

## 1. 목표
- US/KR 단일국가/비교/전이 경로/KR 부동산 질의를 표준 스키마로 처리한다.
- 근거 인용과 불확실성 표기를 강제해 환각 리스크를 낮춘다.
- 데이터 부재 시 C안(선응답 + 수집 안내 + 후속 보강) 정책을 제품 동작으로 고정한다.

## 2. 기간
- 권장 기간: 2026-04-27 ~ 2026-05-15 (2~3주)

## 3. 작업 스트림
### 3.1 질의 스키마/파서 확장
- [ ] `country in {US, KR, US-KR}`, `compare_mode`, `region_code`, `property_type` 파싱 구현
- [ ] 행정동 질의를 법정동 코드 집합으로 확장하는 규칙 적용
- [ ] 질의 타입별 라우팅(단일국가/비교/전이/부동산) 구현

예상 대상 코드
- `hobot/service/graph/rag/context_api.py`
- `hobot/service/graph/rag/response_generator.py`

### 3.2 답변 템플릿/가드레일
- [ ] 미국-한국 비교 템플릿 구현
- [ ] KR 부동산 지역/유형 템플릿 구현
- [ ] 추천/타이밍 질문은 조건형 시나리오 출력으로 강제

### 3.3 근거 인용/검증 파이프라인
- [ ] 답변별 근거 3~10개 인용 강제
- [ ] 근거 없는 문장 필터링 규칙 구현
- [ ] 확신도(High/Medium/Low + score) 산출 로직 연결

예상 대상 코드
- `hobot/service/graph/rag/response_generator.py`
- `hobot/service/graph/impact/quality_metrics.py`

### 3.4 데이터 부재 대응 정책(C안)
- [ ] `data_freshness`, `collection_eta_minutes`, `used_evidence_count` 응답 필드 추가
- [보류] 온디맨드 수집 상태와 QA 응답 연결
- [ ] 수집 완료 후 보강 응답(재질의 우선 반환) 동작 구현
- [x] Top50 범위 외 질의에 대해 “현재 수집 범위 밖 데이터 미보유” 응답 템플릿 고정

### 3.5 필수 질문 6개 JSON 스키마 검증기
- [ ] Q1~Q6 답변 형식 검증기 구현
- [ ] 필수 필드/타입/가드레일 자동 검증
- [ ] 회귀 테스트에 스키마 검증 단계 추가

예상 대상 테스트
- `hobot/tests/test_phase_d_response_generator.py`
- `hobot/tests/test_phase_d_context_api.py`

## 4. 완료 기준 (DoD)
- Q1~Q6 질의가 표준 JSON 스키마를 만족하고 근거 인용이 누락되지 않는다.
- 데이터 부족 상황에서도 C안 정책에 따라 사용자가 즉시 상태를 이해할 수 있다.
- US-KR 비교 질의 P95 응답시간 목표(<8초) 측정이 가능해진다.

## 5. 리스크/대응
- 리스크: 템플릿 고정으로 답변 유연성 저하
- 대응: 템플릿은 필수 메타만 강제하고 본문은 유연 생성 허용
- 리스크: 근거 인용 강제로 응답 지연 증가
- 대응: 후보 회수 단계에서 우선순위 캐시/인덱스 최적화 병행

## 6. Phase 5 인계 항목
- Q1~Q6 회귀 테스트 결과 리포트
- QA 응답 메타 필드 관측 대시보드 샘플
- 지연 구간 프로파일링 결과
