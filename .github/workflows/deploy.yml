name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # main Î∏åÎûúÏπòÏóê pushÎê† Îïå Î∞∞Ìè¨
  workflow_dispatch:  # ÏàòÎèô Ïã§ÌñâÎèÑ Í∞ÄÎä•

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå Error: EC2_HOST variable is not set"
            exit 1
          fi
          echo "üîç Attempting to connect to EC2 host: ${EC2_HOST}"
          if ! ssh-keyscan -H ${EC2_HOST} >> ~/.ssh/known_hosts 2>&1; then
            echo "‚ùå Error: Failed to connect to EC2 host ${EC2_HOST}"
            echo "Please check:"
            echo "  1. EC2 instance is running"
            echo "  2. IP address is correct (current: ${EC2_HOST})"
            echo "  3. Security Group allows SSH (port 22) from GitHub Actions IPs"
            echo "  4. Network connectivity"
            exit 1
          fi
          echo "‚úÖ Successfully added ${EC2_HOST} to known_hosts"
      
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
          EC2_USER: ${{ vars.EC2_USER }}
          DEPLOY_PATH: ${{ vars.EC2_DEPLOYMENT_PATH || '/home/ec2-user/hobot-service' }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          # ÌôòÍ≤Ω Î≥ÄÏàò secrets (ENV_ Ï†ëÎëêÏÇ¨ ÏÇ¨Ïö©)
          SL_TOKEN: ${{ secrets.ENV_SL_TOKEN }}
          UP_ACCESS_KEY: ${{ secrets.ENV_UP_ACCESS_KEY }}
          UP_SECRET_KEY: ${{ secrets.ENV_UP_SECRET_KEY }}
          HT_API_KEY: ${{ secrets.ENV_HT_API_KEY }}
          HT_SECRET_KEY: ${{ secrets.ENV_HT_SECRET_KEY }}
          HT_ACCOUNT: ${{ secrets.ENV_HT_ACCOUNT }}
          HT_ID: ${{ secrets.ENV_HT_ID }}
          OPENAI_API_KEY: ${{ secrets.ENV_OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.ENV_GEMINI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.ENV_TAVILY_API_KEY }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << ENDSSH
            set -e
            
            export DEPLOY_PATH="${DEPLOY_PATH}"
            export GH_TOKEN="${GH_TOKEN}"
            # ÌôòÍ≤Ω Î≥ÄÏàò export (SSH ÏÑ∏ÏÖò ÎÇ¥ÏóêÏÑú ÏÇ¨Ïö©)
            export SL_TOKEN="${SL_TOKEN}"
            export UP_ACCESS_KEY="${UP_ACCESS_KEY}"
            export UP_SECRET_KEY="${UP_SECRET_KEY}"
            export HT_API_KEY="${HT_API_KEY}"
            export HT_SECRET_KEY="${HT_SECRET_KEY}"
            export HT_ACCOUNT="${HT_ACCOUNT}"
            export HT_ID="${HT_ID}"
            export OPENAI_API_KEY="${OPENAI_API_KEY}"
            export GEMINI_API_KEY="${GEMINI_API_KEY}"
            export TAVILY_API_KEY="${TAVILY_API_KEY}"
            
            echo "üöÄ Starting deployment..."
            echo "üìÅ Deploy path: \${DEPLOY_PATH}"
            
            # Î∞∞Ìè¨ ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
            cd \${DEPLOY_PATH} || {
              echo "‚ùå Deploy directory not found. Creating..."
              mkdir -p \${DEPLOY_PATH}
              cd \${DEPLOY_PATH}
            }
            
            # Git pull (ÎòêÎäî Ï¥àÍ∏∞ ÌÅ¥Î°†)
            if [ -d ".git" ]; then
              echo "üì• Pulling latest changes..."
              git pull https://\${GH_TOKEN}@github.com/${{ github.repository }}.git main || true
            else
              echo "üì• Cloning repository..."
              # Í∏∞Ï°¥ ÎîîÎ†âÌÜ†Î¶¨Í∞Ä ÎπÑÏñ¥ÏûàÏßÄ ÏïäÏúºÎ©¥ Î∞±ÏóÖ ÌõÑ ÌÅ¥Î°†
              if [ "\$(ls -A . 2>/dev/null)" ]; then
                echo "‚ö†Ô∏è Directory is not empty, backing up existing files..."
                cd ..
                BACKUP_NAME="\${DEPLOY_PATH}.backup.\$(date +%s)"
                echo "üì¶ Backing up to: \${BACKUP_NAME}"
                mv \${DEPLOY_PATH} \${BACKUP_NAME}
                mkdir -p \${DEPLOY_PATH}
                cd \${DEPLOY_PATH}
              fi
              git clone https://\${GH_TOKEN}@github.com/${{ github.repository }}.git .
            fi
            
            # Backend Î∞∞Ìè¨
            echo "üîß Setting up backend..."
            cd hobot
            
            # Python 3.12 ÌôïÏù∏
            echo "üêç Checking for Python 3.12..."
            if ! command -v python3.12 &> /dev/null; then
              echo "‚ùå Error: Python 3.12 is not installed"
              echo "Please install Python 3.12 manually before deployment."
              echo "Available Python versions:"
              command -v python3 &> /dev/null && python3 --version || echo "python3 not found"
              command -v python &> /dev/null && python --version || echo "python not found"
              exit 1
            else
              echo "‚úÖ Python 3.12 is installed"
              python3.12 --version
            fi
            
            # Python Í∞ÄÏÉÅÌôòÍ≤Ω ÏÑ§Ï†ï (uv ÏÇ¨Ïö©)
            if [ ! -d "venv" ]; then
              echo "üêç Creating virtual environment with uv..."
              
              # uv ÏÑ§Ïπò ÌôïÏù∏
              if ! command -v uv &> /dev/null; then
                echo "üì¶ uv not found. Installing uv..."
                curl -LsSf https://astral.sh/uv/install.sh | sh
                export PATH="\$HOME/.cargo/bin:\$PATH"
                # ÏÑ§Ïπò ÌôïÏù∏
                if ! command -v uv &> /dev/null; then
                  echo "‚ùå Error: Failed to install uv"
                  exit 1
                fi
                echo "‚úÖ uv installed successfully"
              else
                echo "‚úÖ uv is already installed"
                uv --version
              fi
              
              # uvÎ°ú Í∞ÄÏÉÅÌôòÍ≤Ω ÏÉùÏÑ±
              echo "üîß Creating virtual environment with uv venv venv --python 3.12..."
              if ! uv venv venv --python 3.12 2>&1; then
                echo "‚ùå Failed to create virtual environment with uv"
                exit 1
              fi
              echo "‚úÖ Virtual environment created successfully with uv"
              
              # Í∞ÄÏÉÅÌôòÍ≤Ω ÌååÏùº Í∂åÌïú ÏÑ§Ï†ï
              echo "üîß Setting permissions for virtual environment files..."
              chmod +x venv/bin/* 2>/dev/null || true
              chmod +x venv/bin/activate 2>/dev/null || true
              if [ -f "venv/bin/activate" ]; then
                chmod 755 venv/bin/activate
                echo "‚úÖ activate script permissions set"
              fi
              
              # pip ÏÑ§Ïπò (uvÎ°ú ÏÉùÏÑ±Ìïú Í∞ÄÏÉÅÌôòÍ≤ΩÏóêÎäî pipÍ∞Ä ÏóÜÏùÑ Ïàò ÏûàÏùå)
              echo "üì¶ Installing pip in virtual environment..."
              if [ -f "venv/bin/python" ]; then
                venv/bin/python -m ensurepip --upgrade --default-pip 2>&1 || {
                  echo "‚ö†Ô∏è ensurepip failed, trying get-pip.py..."
                  curl -s https://bootstrap.pypa.io/get-pip.py -o get-pip.py
                  venv/bin/python get-pip.py 2>&1
                  rm -f get-pip.py
                }
                # pip ÏÑ§Ïπò ÌôïÏù∏
                if venv/bin/python -m pip --version 2>&1; then
                  echo "‚úÖ pip installed successfully"
                else
                  echo "‚ùå Error: Failed to install pip"
                  exit 1
                fi
              else
                echo "‚ùå Error: Python executable not found in venv"
                exit 1
              fi
            else
              echo "‚úÖ Virtual environment already exists"
            fi
            
            # Í∞ÄÏÉÅÌôòÍ≤Ω ÌôïÏù∏
            if [ ! -d "venv" ]; then
              echo "‚ùå Error: venv directory was not created"
              exit 1
            fi
            echo "‚úÖ Virtual environment directory exists"
          
          # Í∞ÄÏÉÅÌôòÍ≤Ω ÌôúÏÑ±Ìôî ÌôïÏù∏ Î∞è Í∂åÌïú ÏÑ§Ï†ï
          if [ ! -f "venv/bin/activate" ]; then
            echo "‚ùå Error: venv/bin/activate not found"
            echo "Virtual environment structure:"
            ls -la venv/ 2>/dev/null || echo "venv directory does not exist"
            exit 1
          fi
          
          # activate Ïä§ÌÅ¨Î¶ΩÌä∏ Í∂åÌïú ÌôïÏù∏ Î∞è ÏàòÏ†ï
          echo "üîß Checking activate script permissions..."
          if [ ! -x "venv/bin/activate" ]; then
            echo "‚ö†Ô∏è activate script is not executable, fixing permissions..."
            chmod +x venv/bin/activate
            chmod 755 venv/bin/activate
          fi
          
          # venv/bin ÎîîÎ†âÌÜ†Î¶¨Ïùò Î™®Îì† Ïã§Ìñâ ÌååÏùº Í∂åÌïú ÌôïÏù∏
          echo "üîß Setting permissions for venv/bin files..."
          chmod +x venv/bin/* 2>/dev/null || true
          echo "‚úÖ Virtual environment permissions set"
          
          # Python Ïã§Ìñâ ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏ (Í∞ÄÏÉÅÌôòÍ≤Ω ÏÉùÏÑ± ÏßÅÌõÑ)
          if [ ! -f "venv/bin/python" ]; then
            echo "‚ùå Error: venv/bin/python not found after venv creation"
            echo "üìã Contents of venv/bin:"
            ls -la venv/bin/ 2>/dev/null || echo "venv/bin directory does not exist"
            echo "üîß Attempting to recreate venv with uv..."
            rm -rf venv
            if ! uv venv venv --python 3.12 2>&1; then
              echo "‚ùå Failed to recreate venv with uv"
              exit 1
            fi
            if [ ! -f "venv/bin/python" ]; then
              echo "‚ùå Failed to create Python executable in venv"
              exit 1
            fi
            echo "‚úÖ Python executable created after recreation"
          else
            echo "‚úÖ Python executable found: venv/bin/python"
            ls -la venv/bin/python
          fi
          
          # Python Ïã§Ìñâ Í∂åÌïú ÌôïÏù∏
          if [ ! -x "venv/bin/python" ]; then
            echo "‚ö†Ô∏è Python is not executable, fixing permissions..."
            chmod +x venv/bin/python
            if [ ! -x "venv/bin/python" ]; then
              echo "‚ùå Failed to make Python executable"
              exit 1
            fi
            echo "‚úÖ Python permissions fixed"
          fi
          
          # Python Î≤ÑÏ†Ñ ÌÖåÏä§Ìä∏
          echo "üîç Testing Python executable..."
          if venv/bin/python --version 2>&1; then
            echo "‚úÖ Python executable works correctly"
          else
            echo "‚ùå Python executable test failed"
            exit 1
          fi
          
          source venv/bin/activate
          
          # Python Î™ÖÎ†πÏñ¥ ÌôïÏù∏ (Í∞ÄÏÉÅÌôòÍ≤Ω ÎÇ¥Î∂ÄÏóêÏÑúÎäî Í∞ÄÏÉÅÌôòÍ≤ΩÏùò Python ÏÇ¨Ïö©)
          # Í∞ÄÏÉÅÌôòÍ≤ΩÏù¥ ÌôúÏÑ±ÌôîÎêòÎ©¥ 'python'Ïù¥ Í∞ÄÏÉÅÌôòÍ≤ΩÏùò PythonÏùÑ Í∞ÄÎ¶¨ÌÇ¥
          # ÌïòÏßÄÎßå Python 3.12Î•º Î™ÖÏãúÏ†ÅÏúºÎ°ú ÏÇ¨Ïö©
          if command -v python3.12 &> /dev/null; then
            PYTHON_CMD="python3.12"
          elif command -v python &> /dev/null; then
            PYTHON_CMD="python"
          elif command -v python3 &> /dev/null; then
            PYTHON_CMD="python3"
          else
            # Í∞ÄÏÉÅÌôòÍ≤ΩÏùò Python ÏßÅÏ†ë ÏÇ¨Ïö©
            PYTHON_CMD="venv/bin/python"
          fi
          echo "üìù Using Python: \$PYTHON_CMD"
          \$PYTHON_CMD --version
          
          # Python Î≤ÑÏ†Ñ ÌôïÏù∏ (3.12Ïù∏ÏßÄ ÌôïÏù∏)
          PYTHON_VERSION=\$(\$PYTHON_CMD --version 2>&1 | awk '{print \$2}' | cut -d. -f1,2)
          if [ "\$PYTHON_VERSION" != "3.12" ]; then
            echo "‚ö†Ô∏è Warning: Expected Python 3.12, but got \$PYTHON_VERSION"
            echo "üîç Checking venv Python version..."
            if [ -f "venv/bin/python" ]; then
              venv/bin/python --version
            fi
          else
            echo "‚úÖ Python 3.12 confirmed"
          fi
          
          # pipÍ∞Ä ÏóÜÏúºÎ©¥ ÏÑ§Ïπò
          if ! command -v pip &> /dev/null; then
            echo "üì¶ Installing pip..."
            curl -s https://bootstrap.pypa.io/get-pip.py -o get-pip.py || {
              echo "‚ö†Ô∏è Failed to download get-pip.py, trying ensurepip..."
              \$PYTHON_CMD -m ensurepip --upgrade --default-pip || {
                echo "‚ùå Failed to install pip"
                exit 1
              }
            }
            if [ -f "get-pip.py" ]; then
              \$PYTHON_CMD get-pip.py --user || \$PYTHON_CMD get-pip.py || {
                echo "‚ö†Ô∏è get-pip.py failed, trying ensurepip..."
                \$PYTHON_CMD -m ensurepip --upgrade --default-pip
              }
              rm -f get-pip.py
              # pipÎ•º Í∞ÄÏÉÅÌôòÍ≤ΩÏóê Î≥µÏÇ¨
              if [ -f ~/.local/bin/pip ]; then
                cp ~/.local/bin/pip venv/bin/pip 2>/dev/null || true
                cp -r ~/.local/lib/python*/site-packages/pip* venv/lib/python*/site-packages/ 2>/dev/null || true
              fi
            fi
          fi
          
          # pip ÌôïÏù∏ Î∞è ÏÑ§Ïπò
          echo "üîç Checking pip installation..."
          if ! \$PYTHON_CMD -m pip --version 2>&1; then
            echo "üì¶ pip not found, installing pip..."
            \$PYTHON_CMD -m ensurepip --upgrade --default-pip 2>&1 || {
              echo "‚ö†Ô∏è ensurepip failed, trying get-pip.py..."
              curl -s https://bootstrap.pypa.io/get-pip.py -o get-pip.py
              \$PYTHON_CMD get-pip.py 2>&1
              rm -f get-pip.py
            }
            if ! \$PYTHON_CMD -m pip --version 2>&1; then
              echo "‚ùå Error: Failed to install pip"
              exit 1
            fi
            echo "‚úÖ pip installed successfully"
          else
            echo "‚úÖ pip is available"
            \$PYTHON_CMD -m pip --version
          fi
          
          # ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
          echo "üì¶ Installing Python dependencies..."
          \$PYTHON_CMD -m pip install --upgrade pip || echo "‚ö†Ô∏è pip upgrade failed, continuing..."
          \$PYTHON_CMD -m pip install -r requirements.txt
          
          # gunicorn Î™®Îìà ÌôïÏù∏
          echo "üîç Verifying gunicorn installation..."
          if ! \$PYTHON_CMD -m gunicorn --version 2>&1; then
            echo "‚ùå Error: gunicorn module not found after installation"
            echo "üìã Installed packages:"
            \$PYTHON_CMD -m pip list | grep -i gunicorn || echo "gunicorn not found in pip list"
            echo "üì¶ Attempting to install gunicorn explicitly..."
            \$PYTHON_CMD -m pip install gunicorn[gevent] || \$PYTHON_CMD -m pip install gunicorn
            if ! \$PYTHON_CMD -m gunicorn --version 2>&1; then
              echo "‚ùå Error: Failed to install gunicorn"
              exit 1
            fi
          fi
          echo "‚úÖ gunicorn module verified"
          
          # .env ÌååÏùº ÏÉùÏÑ± (GitHub Actions secretsÏóêÏÑú)
          echo "üîê Creating .env file from GitHub Actions secrets..."
          {
            echo "# Environment variables for Hobot service"
            echo "# This file is generated automatically during deployment"
            echo "# Do not commit this file to git"
            echo ""
            echo "# Slack API"
            echo "SL_TOKEN=\${SL_TOKEN}"
            echo ""
            echo "# Upbit API"
            echo "UP_ACCESS_KEY=\${UP_ACCESS_KEY}"
            echo "UP_SECRET_KEY=\${UP_SECRET_KEY}"
            echo ""
            echo "# KIS (ÌïúÍµ≠Ìà¨ÏûêÏ¶ùÍ∂å) API"
            echo "HT_API_KEY=\${HT_API_KEY}"
            echo "HT_SECRET_KEY=\${HT_SECRET_KEY}"
            echo "HT_ACCOUNT=\${HT_ACCOUNT}"
            echo "HT_ID=\${HT_ID}"
            echo ""
            echo "# OpenAI API"
            echo "OPENAI_API_KEY=\${OPENAI_API_KEY}"
            echo ""
            echo "# Google API"
            echo "GOOGLE_API_KEY=\${GOOGLE_API_KEY}"
            echo ""
            echo "# Gemini API"
            echo "GEMINI_API_KEY=\${GEMINI_API_KEY}"
            echo ""
            echo "# Tavily API"
            echo "TAVILY_API_KEY=\${TAVILY_API_KEY}"
          } > .env
          # .env ÌååÏùº Í∂åÌïú ÏÑ§Ï†ï (ÏÜåÏú†ÏûêÎßå ÏùΩÍ∏∞/Ïì∞Í∏∞)
          chmod 600 .env
          echo "‚úÖ .env file created successfully"
          # .env ÌååÏùº ÎÇ¥Ïö© ÌôïÏù∏ (ÎØºÍ∞ê Ï†ïÎ≥¥Îäî ÎßàÏä§ÌÇπ)
          echo "üîç Verifying .env file (masked)..."
          if [ -f .env ]; then
            echo "‚úÖ .env file exists"
            # ÌôòÍ≤Ω Î≥ÄÏàò Í∞úÏàò ÌôïÏù∏ (Îπà Ï§Ñ Ï†úÏô∏)
            ENV_COUNT=\$(grep -v '^#' .env | grep -v '^$' | wc -l)
            echo "üìä Environment variables count: \$ENV_COUNT"
          else
            echo "‚ùå .env file was not created"
            exit 1
          fi
          
          # Ï†ÑÎûµ Ï¥àÍ∏∞Ìôî (KISÏôÄ UpbitÎ•º PAUSEÎ°ú ÏÑ§Ï†ï)
          echo "‚è∏Ô∏è Initializing strategies to PAUSE..."
          \$PYTHON_CMD service/utils/init_strategy_pause.py
          
          # Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          mkdir -p logs
          
          # Systemd ÏÑúÎπÑÏä§ ÏÑ§Ï†ï (ÏÑ†ÌÉùÏÇ¨Ìï≠)
          if [ -f "../.github/deploy/hobot.service" ]; then
            echo "‚öôÔ∏è Setting up systemd service..."
            sudo cp ../.github/deploy/hobot.service /etc/systemd/system/hobot.service
            # Í≤ΩÎ°ú Î∞è ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (Î™®Îì† Í≤ΩÎ°ú ÏπòÌôò)
            sudo sed -i "s|/home/ec2-user/hobot-service|\${DEPLOY_PATH}|g" /etc/systemd/system/hobot.service
            sudo sed -i "s|User=ec2-user|User=\$(whoami)|g" /etc/systemd/system/hobot.service
            # ExecStartPre Î™ÖÎ†π ÎÇ¥Î∂ÄÏùò Í≤ΩÎ°úÎèÑ ÏπòÌôò (bash -c ÎÇ¥Î∂ÄÏùò Í≤ΩÎ°ú)
            sudo sed -i "s|/home/ec2-user/hobot-service|\${DEPLOY_PATH}|g" /etc/systemd/system/hobot.service
            # Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ ÎØ∏Î¶¨ ÏÉùÏÑ± (ExecStartPreÍ∞Ä Ï†úÎåÄÎ°ú ÏûëÎèôÌïòÎèÑÎ°ù)
            sudo mkdir -p \${DEPLOY_PATH}/hobot/logs
            sudo chown -R \$(whoami):\$(whoami) \${DEPLOY_PATH}/hobot/logs
            # Python Ïã§Ìñâ ÌååÏùº Í≤ΩÎ°ú ÌôïÏù∏ Î∞è ÏàòÏ†ï (ÏÉÅÏÑ∏ Î°úÍπÖ)
            echo "üîç Checking Python executable path..."
            PYTHON_PATH=\${DEPLOY_PATH}/hobot/venv/bin/python
            echo "üìù Expected Python path: \$PYTHON_PATH"
            
            # Í∞ÄÏÉÅÌôòÍ≤Ω ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏
            if [ ! -d "\${DEPLOY_PATH}/hobot/venv" ]; then
              echo "‚ùå Virtual environment directory not found: \${DEPLOY_PATH}/hobot/venv"
              echo "üìÅ Listing hobot directory:"
              ls -la \${DEPLOY_PATH}/hobot/ 2>&1 || echo "hobot directory does not exist"
              exit 1
            fi
            
            # venv/bin ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏
            if [ ! -d "\${DEPLOY_PATH}/hobot/venv/bin" ]; then
              echo "‚ùå venv/bin directory not found: \${DEPLOY_PATH}/hobot/venv/bin"
              echo "üìÅ Listing venv directory:"
              ls -la \${DEPLOY_PATH}/hobot/venv/ 2>&1 || echo "venv directory does not exist"
              exit 1
            fi
            
            # Python ÌååÏùº Î™©Î°ù Ï∂úÎ†•
            echo "üìã Python files in venv/bin:"
            ls -la \${DEPLOY_PATH}/hobot/venv/bin/python* 2>&1 || echo "No Python files found"
            
            if [ ! -f "\$PYTHON_PATH" ]; then
              echo "‚ùå Python not found at \$PYTHON_PATH"
              echo "üîç Checking actual Python version in venv..."
              # Í∞ÄÏÉÅÌôòÍ≤ΩÏùò Python Ïã¨Î≥ºÎ¶≠ ÎßÅÌÅ¨ ÌôïÏù∏
              if [ -L "\${DEPLOY_PATH}/hobot/venv/bin/python" ]; then
                REAL_PYTHON=\$(readlink -f \${DEPLOY_PATH}/hobot/venv/bin/python)
                echo "üìù venv/bin/python is a symlink to: \$REAL_PYTHON"
                if [ -f "\$REAL_PYTHON" ]; then
                  PYTHON_PATH="\$REAL_PYTHON"
                  echo "‚úÖ Using real Python path: \$PYTHON_PATH"
                  # Python 3.12Ïù∏ÏßÄ ÌôïÏù∏
                  PYTHON_VER=\$("\$PYTHON_PATH" --version 2>&1 | awk '{print \$2}' | cut -d. -f1,2)
                  if [ "\$PYTHON_VER" != "3.12" ]; then
                    echo "‚ö†Ô∏è Warning: venv Python is \$PYTHON_VER, not 3.12"
                    echo "üîç Looking for Python 3.12..."
                    if command -v python3.12 &> /dev/null; then
                      PYTHON_PATH=\$(which python3.12)
                      echo "‚úÖ Found Python 3.12 at: \$PYTHON_PATH"
                    else
                      echo "‚ùå Python 3.12 not found. Please install Python 3.12 first."
                      exit 1
                    fi
                  fi
                  # bash -c ÌòïÏãù Ïú†ÏßÄÌïòÎ©¥ÏÑú Python Í≤ΩÎ°úÎßå ÍµêÏ≤¥
                  sudo sed -i "s|/home/ec2-user/hobot-service/hobot/venv/bin/python|\$PYTHON_PATH|g" /etc/systemd/system/hobot.service
                  sudo sed -i "s|\${DEPLOY_PATH}/hobot/venv/bin/python|\$PYTHON_PATH|g" /etc/systemd/system/hobot.service
                else
                  echo "‚ùå Real Python path does not exist: \$REAL_PYTHON"
                  exit 1
                fi
              else
                echo "‚ùå venv/bin/python is not a symlink and does not exist"
                echo "üîç Searching for Python 3.12..."
                if command -v python3.12 &> /dev/null; then
                  PYTHON_PATH=\$(which python3.12)
                  echo "‚úÖ Found Python 3.12 at: \$PYTHON_PATH"
                else
                  echo "‚ùå Python 3.12 not found. Please install Python 3.12 first."
                  exit 1
                fi
                echo "üìù Updating systemd service to use: \$PYTHON_PATH"
                # bash -c ÌòïÏãù Ïú†ÏßÄÌïòÎ©¥ÏÑú Python Í≤ΩÎ°úÎßå ÍµêÏ≤¥
                sudo sed -i "s|/home/ec2-user/hobot-service/hobot/venv/bin/python|\$PYTHON_PATH|g" /etc/systemd/system/hobot.service
                sudo sed -i "s|\${DEPLOY_PATH}/hobot/venv/bin/python|\$PYTHON_PATH|g" /etc/systemd/system/hobot.service
              fi
            else
              echo "‚úÖ Python found at: \$PYTHON_PATH"
              # Ïã§Ï†ú Python Î≤ÑÏ†Ñ ÌôïÏù∏ (3.12Ïù∏ÏßÄ ÌôïÏù∏)
              PYTHON_VER=\$("\$PYTHON_PATH" --version 2>&1 | awk '{print \$2}' | cut -d. -f1,2)
              echo "üìù Python version: \$PYTHON_VER"
              if [ "\$PYTHON_VER" != "3.12" ]; then
                echo "‚ö†Ô∏è Warning: Python at \$PYTHON_PATH is \$PYTHON_VER, not 3.12"
                echo "üîç Looking for Python 3.12..."
                if command -v python3.12 &> /dev/null; then
                  PYTHON_PATH=\$(which python3.12)
                  echo "‚úÖ Found Python 3.12 at: \$PYTHON_PATH"
                  echo "üìù Updating systemd service to use: \$PYTHON_PATH"
                  # bash -c ÌòïÏãù Ïú†ÏßÄÌïòÎ©¥ÏÑú Python Í≤ΩÎ°úÎßå ÍµêÏ≤¥
                  sudo sed -i "s|/home/ec2-user/hobot-service/hobot/venv/bin/python|\$PYTHON_PATH|g" /etc/systemd/system/hobot.service
                  sudo sed -i "s|\${DEPLOY_PATH}/hobot/venv/bin/python|\$PYTHON_PATH|g" /etc/systemd/system/hobot.service
                else
                  echo "‚ùå Python 3.12 not found. Please install Python 3.12 first."
                  exit 1
                fi
              else
                echo "‚úÖ Python 3.12 confirmed"
              fi
            fi
            
            # Python Ïã§Ìñâ Í∂åÌïú ÌôïÏù∏
            echo "üîç Checking Python executable permissions..."
            if [ ! -x "\$PYTHON_PATH" ]; then
              echo "‚ùå Python is not executable: \$PYTHON_PATH"
              echo "üìã File permissions:"
              ls -la "\$PYTHON_PATH" 2>&1
              echo "üîß Attempting to fix permissions..."
              chmod +x "\$PYTHON_PATH" 2>&1 || sudo chmod +x "\$PYTHON_PATH" 2>&1
              if [ ! -x "\$PYTHON_PATH" ]; then
                echo "‚ùå Failed to make Python executable"
                exit 1
              fi
              echo "‚úÖ Permissions fixed"
            else
              echo "‚úÖ Python is executable"
            fi
            
            # Python Î≤ÑÏ†Ñ ÌôïÏù∏
            echo "üîç Testing Python execution..."
            if "\$PYTHON_PATH" --version 2>&1; then
              echo "‚úÖ Python version check successful"
            else
              echo "‚ö†Ô∏è Warning: Python version check failed, but continuing..."
            fi
            sudo systemctl daemon-reload
            sudo systemctl enable hobot.service
            echo "üîÑ Restarting service..."
            sudo systemctl restart hobot.service
            sleep 3
            # ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏
            if sudo systemctl is-active --quiet hobot.service; then
              echo "‚úÖ Service is running!"
              sudo systemctl status hobot.service --no-pager -l
            else
              echo "‚ùå Service failed to start. Checking status..."
              sudo systemctl status hobot.service --no-pager -l
              echo ""
              echo "üìã Recent service logs (last 50 lines):"
              sudo journalctl -u hobot.service -n 50 --no-pager
              echo ""
              echo "üîç Checking Python executable in systemd service file:"
              sudo grep "ExecStart" /etc/systemd/system/hobot.service || echo "ExecStart not found in service file"
              echo ""
              echo "üîç Verifying Python path exists:"
              PYTHON_PATH=\$(sudo grep "ExecStart" /etc/systemd/system/hobot.service | awk '{print $2}' | head -1)
              if [ ! -z "\$PYTHON_PATH" ]; then
                echo "Python path from service file: \$PYTHON_PATH"
                if [ -f "\$PYTHON_PATH" ]; then
                  echo "‚úÖ File exists"
                  ls -la "\$PYTHON_PATH"
                  if [ -x "\$PYTHON_PATH" ]; then
                    echo "‚úÖ File is executable"
                    "\$PYTHON_PATH" --version 2>&1 || echo "‚ö†Ô∏è Cannot execute Python"
                  else
                    echo "‚ùå File is NOT executable"
                  fi
                else
                  echo "‚ùå File does NOT exist"
                fi
              fi
              echo ""
              echo "üîç Checking working directory:"
              WORKING_DIR=\$(sudo grep "WorkingDirectory" /etc/systemd/system/hobot.service | awk '{print $2}')
              echo "Working directory: \$WORKING_DIR"
              if [ ! -z "\$WORKING_DIR" ]; then
                ls -la "\$WORKING_DIR" 2>&1 || echo "Working directory does not exist"
              fi
              exit 1
            fi
          else
            # Systemd ÏóÜÏù¥ ÏßÅÏ†ë Ïã§Ìñâ
            echo "üõë Stopping existing services..."
            PORT=8991
            EXISTING_PIDS=\$(lsof -ti :\$PORT 2>/dev/null || true)
            if [ ! -z "\$EXISTING_PIDS" ]; then
              echo "Killing processes on port \$PORT: \$EXISTING_PIDS"
              kill -9 \$EXISTING_PIDS 2>/dev/null || true
              sleep 2
            fi
            
            # GunicornÏúºÎ°ú ÏÑúÎ≤Ñ ÏãúÏûë (Î∞±Í∑∏ÎùºÏö¥Îìú)
            echo "üöÄ Starting FastAPI server with Gunicorn..."
            # Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏
            mkdir -p logs
            # Gunicorn Ïã§Ìñâ (Î°úÍ∑∏ ÌååÏùºÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏)
            nohup \$PYTHON_CMD -m gunicorn -c gunicorn.conf.py asgi:asgi_app > logs/gunicorn.log 2>&1 &
            GUNICORN_PID=\$!
            echo "üìù Gunicorn started with PID: \$GUNICORN_PID"
            # ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä Ïã§Ï†úÎ°ú Ïã§ÌñâÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            sleep 2
            if ps -p \$GUNICORN_PID > /dev/null 2>&1; then
              echo "‚úÖ Gunicorn process is running (PID: \$GUNICORN_PID)"
            else
              echo "‚ùå Gunicorn process failed to start. Check logs/gunicorn.log for errors:"
              tail -20 logs/gunicorn.log 2>/dev/null || echo "Log file not found"
              exit 1
            fi
          fi
          
          echo "‚úÖ Backend deployment completed!"
          
          # Frontend Î∞∞Ìè¨ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
          if [ -d "../hobot-ui" ]; then
            echo "üé® Setting up frontend..."
            cd ../hobot-ui
            
            # Node.js ÌôïÏù∏
            if command -v node &> /dev/null; then
              echo "üì¶ Installing frontend dependencies..."
              npm install
              
              # Í∏∞Ï°¥ ÌîÑÎ°†Ìä∏ÏóîÎìú ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å
              echo "üõë Stopping existing frontend services..."
              FRONTEND_PORT=3000
              EXISTING_PIDS=\$(lsof -ti :\$FRONTEND_PORT 2>/dev/null || true)
              if [ ! -z "\$EXISTING_PIDS" ]; then
                echo "Killing processes on port \$FRONTEND_PORT: \$EXISTING_PIDS"
                kill -9 \$EXISTING_PIDS 2>/dev/null || true
                sleep 2
              fi
              
              # npm start ÌîÑÎ°úÏÑ∏Ïä§ÎèÑ ÌôïÏù∏ (Ìè¨Ìä∏Í∞Ä ÏïÑÎãå ÌîÑÎ°úÏÑ∏Ïä§ Ïù¥Î¶ÑÏúºÎ°ú)
              NPM_PIDS=\$(ps aux | grep -E '[n]pm start|[n]ode.*react-scripts' | awk '{print \$2}' || true)
              if [ ! -z "\$NPM_PIDS" ]; then
                echo "Killing existing npm start processes: \$NPM_PIDS"
                kill -9 \$NPM_PIDS 2>/dev/null || true
                sleep 2
              fi
              
              # ÌîÑÎ°†Ìä∏ÏóîÎìú ÏãúÏûë (Î∞±Í∑∏ÎùºÏö¥Îìú)
              echo "üöÄ Starting frontend in background..."
              # Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
              mkdir -p ../hobot/logs
              # npm startÎ•º Î∞±Í∑∏ÎùºÏö¥ÎìúÎ°ú Ïã§Ìñâ
              nohup npm start > ../hobot/logs/frontend.log 2>&1 &
              FRONTEND_PID=\$!
              echo "üìù Frontend started with PID: \$FRONTEND_PID"
              
              # ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä Ïã§Ï†úÎ°ú Ïã§ÌñâÎêòÏóàÎäîÏßÄ ÌôïÏù∏
              sleep 3
              if ps -p \$FRONTEND_PID > /dev/null 2>&1; then
                echo "‚úÖ Frontend process is running (PID: \$FRONTEND_PID)"
              else
                echo "‚ùå Frontend process failed to start. Check logs/frontend.log for errors:"
                tail -20 ../hobot/logs/frontend.log 2>/dev/null || echo "Log file not found"
                echo "‚ö†Ô∏è Frontend deployment failed, but continuing..."
              fi
            else
              echo "‚ö†Ô∏è Node.js not found, skipping frontend deployment"
            fi
          fi
          
          echo "üéâ Deployment completed successfully!"
          ENDSSH
      
      - name: Health Check
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
          EC2_USER: ${{ vars.EC2_USER }}
        run: |
          sleep 10  # ÏÑúÎ≤Ñ ÏãúÏûë ÎåÄÍ∏∞
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            echo "üîç Checking server health..."
            if curl -f http://localhost:8991/ > /dev/null 2>&1; then
              echo "‚úÖ Backend server is healthy!"
            else
              echo "‚ùå Backend server health check failed"
              exit 1
            fi
          ENDSSH

