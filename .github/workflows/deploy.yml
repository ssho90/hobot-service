name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— pushë  ë•Œ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
    - name: Setup SSH
      env:
        EC2_HOST: ${{ vars.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
        if [ -z "$EC2_HOST" ]; then
          echo "âŒ Error: EC2_HOST variable is not set"
          exit 1
        fi
        echo "ğŸ” Attempting to connect to EC2 host: ${EC2_HOST}"
        if ! ssh-keyscan -H ${EC2_HOST} >> ~/.ssh/known_hosts 2>&1; then
          echo "âŒ Error: Failed to connect to EC2 host ${EC2_HOST}"
          echo "Please check:"
          echo "  1. EC2 instance is running"
          echo "  2. IP address is correct (current: ${EC2_HOST})"
          echo "  3. Security Group allows SSH (port 22) from GitHub Actions IPs"
          echo "  4. Network connectivity"
          exit 1
        fi
        echo "âœ… Successfully added ${EC2_HOST} to known_hosts"
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ vars.EC2_HOST }}
        EC2_USER: ${{ vars.EC2_USER }}
        DEPLOY_PATH: ${{ vars.EC2_DEPLOYMENT_PATH || '/home/ec2-user/hobot-service' }}
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << ENDSSH
          set -e
          
          export DEPLOY_PATH="${DEPLOY_PATH}"
          export GH_TOKEN="${GH_TOKEN}"
          
          echo "ğŸš€ Starting deployment..."
          echo "ğŸ“ Deploy path: \${DEPLOY_PATH}"
          
          # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd \${DEPLOY_PATH} || {
            echo "âŒ Deploy directory not found. Creating..."
            mkdir -p \${DEPLOY_PATH}
            cd \${DEPLOY_PATH}
          }
          
          # Git pull (ë˜ëŠ” ì´ˆê¸° í´ë¡ )
          if [ -d ".git" ]; then
            echo "ğŸ“¥ Pulling latest changes..."
            git pull https://\${GH_TOKEN}@github.com/${{ github.repository }}.git main || true
          else
            echo "ğŸ“¥ Cloning repository..."
            # ê¸°ì¡´ ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ ë°±ì—… í›„ í´ë¡ 
            if [ "\$(ls -A . 2>/dev/null)" ]; then
              echo "âš ï¸ Directory is not empty, backing up existing files..."
              cd ..
              BACKUP_NAME="\${DEPLOY_PATH}.backup.\$(date +%s)"
              echo "ğŸ“¦ Backing up to: \${BACKUP_NAME}"
              mv \${DEPLOY_PATH} \${BACKUP_NAME}
              mkdir -p \${DEPLOY_PATH}
              cd \${DEPLOY_PATH}
            fi
            git clone https://\${GH_TOKEN}@github.com/${{ github.repository }}.git .
          fi
          
          # Backend ë°°í¬
          echo "ğŸ”§ Setting up backend..."
          cd hobot
          
          # Python ê°€ìƒí™˜ê²½ ì„¤ì •
          if [ ! -d "venv" ]; then
            echo "ğŸ Creating virtual environment with Python 3.12..."
            # Python 3.12ê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if command -v python3.12 &> /dev/null; then
              PYTHON_CMD="python3.12"
            elif command -v python3 &> /dev/null; then
              PYTHON_CMD="python3"
              PYTHON_VERSION=\$(\$PYTHON_CMD --version 2>&1 | awk '{print \$2}' | cut -d. -f1,2)
              if [ "\$PYTHON_VERSION" != "3.12" ]; then
                echo "âš ï¸ Warning: Python 3.12 not found, using \$PYTHON_VERSION instead"
              fi
            else
              echo "âŒ Error: Python 3 not found"
              exit 1
            fi
            # ensurepipê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ --without-pip ì˜µì…˜ ì‚¬ìš© í›„ pipë¥¼ ë³„ë„ë¡œ ì„¤ì¹˜
            if ! \$PYTHON_CMD -m venv --without-pip venv 2>/dev/null; then
              echo "âš ï¸ --without-pip failed, trying standard venv..."
              if ! \$PYTHON_CMD -m venv venv 2>/dev/null; then
                echo "âŒ Failed to create virtual environment"
                exit 1
              fi
            fi
            echo "âœ… Virtual environment created with \$PYTHON_CMD"
          fi
          
          # ê°€ìƒí™˜ê²½ í™œì„±í™” í™•ì¸
          if [ ! -f "venv/bin/activate" ]; then
            echo "âŒ Error: venv/bin/activate not found"
            echo "Virtual environment structure:"
            ls -la venv/ 2>/dev/null || echo "venv directory does not exist"
            exit 1
          fi
          
          source venv/bin/activate
          
          # Python ëª…ë ¹ì–´ í™•ì¸ (ê°€ìƒí™˜ê²½ ë‚´ë¶€)
          if command -v python3.12 &> /dev/null; then
            PYTHON_CMD="python3.12"
          else
            PYTHON_CMD="python3"
          fi
          
          # pipê°€ ì—†ìœ¼ë©´ ì„¤ì¹˜
          if ! command -v pip &> /dev/null; then
            echo "ğŸ“¦ Installing pip..."
            curl -s https://bootstrap.pypa.io/get-pip.py -o get-pip.py || {
              echo "âš ï¸ Failed to download get-pip.py, trying ensurepip..."
              \$PYTHON_CMD -m ensurepip --upgrade --default-pip || {
                echo "âŒ Failed to install pip"
                exit 1
              }
            }
            if [ -f "get-pip.py" ]; then
              \$PYTHON_CMD get-pip.py --user || \$PYTHON_CMD get-pip.py || {
                echo "âš ï¸ get-pip.py failed, trying ensurepip..."
                \$PYTHON_CMD -m ensurepip --upgrade --default-pip
              }
              rm -f get-pip.py
              # pipë¥¼ ê°€ìƒí™˜ê²½ì— ë³µì‚¬
              if [ -f ~/.local/bin/pip ]; then
                cp ~/.local/bin/pip venv/bin/pip 2>/dev/null || true
                cp -r ~/.local/lib/python*/site-packages/pip* venv/lib/python*/site-packages/ 2>/dev/null || true
              fi
            fi
          fi
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ Installing Python dependencies..."
          pip install --upgrade pip || \$PYTHON_CMD -m ensurepip --upgrade || echo "âš ï¸ pip upgrade failed, continuing..."
          pip install -r requirements.txt
          
          # ì „ëµ ì´ˆê¸°í™” (KISì™€ Upbitë¥¼ PAUSEë¡œ ì„¤ì •)
          echo "â¸ï¸ Initializing strategies to PAUSE..."
          \$PYTHON_CMD service/utils/init_strategy_pause.py
          
          # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p logs
          
          # Systemd ì„œë¹„ìŠ¤ ì„¤ì • (ì„ íƒì‚¬í•­)
          if [ -f "../.github/deploy/hobot.service" ]; then
            echo "âš™ï¸ Setting up systemd service..."
            sudo cp ../.github/deploy/hobot.service /etc/systemd/system/hobot.service
            # ê²½ë¡œ ë° ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
            sudo sed -i "s|/home/ec2-user/hobot-service|\${DEPLOY_PATH}|g" /etc/systemd/system/hobot.service
            sudo sed -i "s|User=ec2-user|User=\$(whoami)|g" /etc/systemd/system/hobot.service
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„± (ExecStartPreê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ë„ë¡)
            sudo mkdir -p \${DEPLOY_PATH}/hobot/logs
            sudo chown -R \$(whoami):\$(whoami) \${DEPLOY_PATH}/hobot/logs
            # Python ì‹¤í–‰ íŒŒì¼ ê²½ë¡œ í™•ì¸ ë° ìˆ˜ì •
            PYTHON_PATH=\${DEPLOY_PATH}/hobot/venv/bin/python
            if [ ! -f "\$PYTHON_PATH" ]; then
              echo "âŒ Python not found at \$PYTHON_PATH, trying python3.12..."
              if command -v python3.12 &> /dev/null; then
                PYTHON_PATH=\$(which python3.12)
              else
                PYTHON_PATH=\$(which python3)
              fi
              echo "ğŸ“ Using Python: \$PYTHON_PATH"
              sudo sed -i "s|ExecStart=.*venv/bin/python|ExecStart=\$PYTHON_PATH|g" /etc/systemd/system/hobot.service
            fi
            # Python ì‹¤í–‰ ê¶Œí•œ í™•ì¸
            if [ ! -x "\$PYTHON_PATH" ]; then
              echo "âŒ Python is not executable: \$PYTHON_PATH"
              exit 1
            fi
            sudo systemctl daemon-reload
            sudo systemctl enable hobot.service
            echo "ğŸ”„ Restarting service..."
            sudo systemctl restart hobot.service
            sleep 3
            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            if sudo systemctl is-active --quiet hobot.service; then
              echo "âœ… Service is running!"
              sudo systemctl status hobot.service --no-pager -l
            else
              echo "âŒ Service failed to start. Checking status..."
              sudo systemctl status hobot.service --no-pager -l
              echo "ğŸ“‹ Recent service logs:"
              sudo journalctl -u hobot.service -n 20 --no-pager
              exit 1
            fi
          else
            # Systemd ì—†ì´ ì§ì ‘ ì‹¤í–‰
            echo "ğŸ›‘ Stopping existing services..."
            PORT=8991
            EXISTING_PIDS=\$(lsof -ti :\$PORT 2>/dev/null || true)
            if [ ! -z "\$EXISTING_PIDS" ]; then
              echo "Killing processes on port \$PORT: \$EXISTING_PIDS"
              kill -9 \$EXISTING_PIDS 2>/dev/null || true
              sleep 2
            fi
            
            # Gunicornìœ¼ë¡œ ì„œë²„ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
            echo "ğŸš€ Starting FastAPI server with Gunicorn..."
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ í™•ì¸
            mkdir -p logs
            # Gunicorn ì‹¤í–‰ (ë¡œê·¸ íŒŒì¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸)
            nohup \$PYTHON_CMD -m gunicorn -c gunicorn.conf.py asgi:asgi_app > logs/gunicorn.log 2>&1 &
            GUNICORN_PID=\$!
            echo "ğŸ“ Gunicorn started with PID: \$GUNICORN_PID"
            # í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤ì œë¡œ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸
            sleep 2
            if ps -p \$GUNICORN_PID > /dev/null 2>&1; then
              echo "âœ… Gunicorn process is running (PID: \$GUNICORN_PID)"
            else
              echo "âŒ Gunicorn process failed to start. Check logs/gunicorn.log for errors:"
              tail -20 logs/gunicorn.log 2>/dev/null || echo "Log file not found"
              exit 1
            fi
          fi
          
          echo "âœ… Backend deployment completed!"
          
          # Frontend ë°°í¬ (ì„ íƒì‚¬í•­)
          if [ -d "../hobot-ui" ]; then
            echo "ğŸ¨ Setting up frontend..."
            cd ../hobot-ui
            
            # Node.js í™•ì¸
            if command -v node &> /dev/null; then
              echo "ğŸ“¦ Installing frontend dependencies..."
              npm install --production
              
              # ë¹Œë“œ (í”„ë¡œë•ì…˜)
              echo "ğŸ—ï¸ Building frontend..."
              npm run build || echo "âš ï¸ Build script not found, skipping..."
            else
              echo "âš ï¸ Node.js not found, skipping frontend deployment"
            fi
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
        ENDSSH
      
      - name: Health Check
        env:
        EC2_HOST: ${{ vars.EC2_HOST }}
        EC2_USER: ${{ vars.EC2_USER }}
        run: |
        sleep 10  # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          echo "ğŸ” Checking server health..."
          if curl -f http://localhost:8991/ > /dev/null 2>&1; then
            echo "âœ… Backend server is healthy!"
          else
            echo "âŒ Backend server health check failed"
            exit 1
          fi
        ENDSSH

