name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'ap-northeast-2' }}

      - name: Whitelist Runner IP
        id: whitelist
        env:
          AWS_SG_ID: ${{ secrets.AWS_SG_ID }}
        run: |
          if [ -z "$AWS_SG_ID" ]; then
            echo "‚ö†Ô∏è AWS_SG_ID secret is not set. Skipping security group update."
            echo "skip_whitelist=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          IP=$(curl -s https://checkip.amazonaws.com)
          echo "Runner IP: $IP"
          echo "runner_ip=$IP" >> $GITHUB_OUTPUT
          
          echo "Adds inbound rule to security group..."
          aws ec2 authorize-security-group-ingress \
            --group-id $AWS_SG_ID \
            --protocol tcp \
            --port 22 \
            --cidr ${IP}/32
          
          echo "skip_whitelist=false" >> $GITHUB_OUTPUT
      
      - name: Setup SSH
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå Error: EC2_HOST variable is not set"
            exit 1
          fi
          
          echo "üîç Connecting to EC2 host: ${EC2_HOST}"
          ssh-keyscan -H ${EC2_HOST} >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ùå Failed to connect to EC2 host"
            exit 1
          }
          echo "‚úÖ SSH connection ready"
      
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
          EC2_USER: ${{ vars.EC2_USER }}
          DEPLOY_PATH: ${{ vars.EC2_DEPLOYMENT_PATH || '/home/ec2-user/hobot-service' }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          SL_TOKEN: ${{ secrets.ENV_SL_TOKEN }}
          UP_ACCESS_KEY: ${{ secrets.ENV_UP_ACCESS_KEY }}
          UP_SECRET_KEY: ${{ secrets.ENV_UP_SECRET_KEY }}
          HT_API_KEY: ${{ secrets.ENV_HT_API_KEY }}
          HT_SECRET_KEY: ${{ secrets.ENV_HT_SECRET_KEY }}
          HT_ACCOUNT: ${{ secrets.ENV_HT_ACCOUNT }}
          HT_ID: ${{ secrets.ENV_HT_ID }}
          OPENAI_API_KEY: ${{ secrets.ENV_OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.ENV_GOOGLE_API_KEY }}
          GEMINI_EMBEDDING_API_KEY: ${{ secrets.GEMINI_EMBEDDING_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.ENV_TAVILY_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          DART_API_KEY: ${{ secrets.DART_API_KEY }}
          MOLIT_API_KEY: ${{ secrets.MOLIT_API_KEY }}
          KOSIS_API_KEY: ${{ secrets.KOSIS_API_KEY }}
          ECOS_API_KEY: ${{ secrets.ECOS_API_KEY }}
          KAKAO_SKILL_WEBHOOK_SECRET: ${{ secrets.KAKAO_SKILL_WEBHOOK_SECRET }}
          KR_TOP50_EARNINGS_WATCH_INTERVAL_MINUTES: ${{ vars.KR_TOP50_EARNINGS_WATCH_INTERVAL_MINUTES || '5' }}
          TIER1_EVENT_SYNC_INCLUDE_KR_IR_NEWS: ${{ vars.TIER1_EVENT_SYNC_INCLUDE_KR_IR_NEWS || '1' }}
          KR_TIER1_IR_FEED_URLS: ${{ vars.KR_TIER1_IR_FEED_URLS || 'https://www.hankyung.com/feed/finance,https://rss.etnews.com/Section902.xml' }}
          GRAPH_RAG_ROUTER_LLM_TIMEOUT_SEC: ${{ vars.GRAPH_RAG_ROUTER_LLM_TIMEOUT_SEC || '10' }}
          GRAPH_RAG_RECENT_DOC_PRIORITY_COUNT: ${{ vars.GRAPH_RAG_RECENT_DOC_PRIORITY_COUNT || '8' }}
          GRAPH_RAG_RECENT_CITATION_TARGET_COUNT: ${{ vars.GRAPH_RAG_RECENT_CITATION_TARGET_COUNT || '1' }}
          GRAPH_RAG_RECENT_CITATION_MAX_AGE_HOURS: ${{ vars.GRAPH_RAG_RECENT_CITATION_MAX_AGE_HOURS || '168' }}
          GRAPH_RAG_DATA_FRESHNESS_WARN_HOURS: ${{ vars.GRAPH_RAG_DATA_FRESHNESS_WARN_HOURS || '72' }}
          GRAPH_RAG_DATA_FRESHNESS_FAIL_HOURS: ${{ vars.GRAPH_RAG_DATA_FRESHNESS_FAIL_HOURS || '168' }}
          GRAPH_RAG_PHASE5_ALERT_ENABLED: ${{ vars.GRAPH_RAG_PHASE5_ALERT_ENABLED || '1' }}
          GRAPH_RAG_PHASE5_ALERT_ONLY_ON_WARNING: ${{ vars.GRAPH_RAG_PHASE5_ALERT_ONLY_ON_WARNING || '1' }}
          GRAPH_RAG_PHASE5_ALERT_CHANNEL: "${{ vars.GRAPH_RAG_PHASE5_ALERT_CHANNEL || '#auto-trading-error' }}"
          GRAPH_RAG_PHASE5_ALERT_CASE_LIMIT: ${{ vars.GRAPH_RAG_PHASE5_ALERT_CASE_LIMIT || '3' }}
          GRAPH_RAG_PHASE5_ALERT_ERROR_MESSAGE_LIMIT: ${{ vars.GRAPH_RAG_PHASE5_ALERT_ERROR_MESSAGE_LIMIT || '2' }}
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          # MySQL Database Configuration
          DB_HOST: ${{ vars.DB_HOST || secrets.DB_HOST }}
          DB_PORT: ${{ vars.DB_PORT || '3306' }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ vars.DB_NAME || 'hobot' }}
          DB_CHARSET: ${{ vars.DB_CHARSET || 'utf8mb4' }}
          # JWT Secret Key
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          # KIS Encryption Master Key
          ENCRYPTION_MASTER_KEY: ${{ secrets.ENCRYPTION_MASTER_KEY }}
          # Neo4j Database Configuration
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USER: ${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          NEO4J_MACRO_URI: ${{ secrets.NEO4J_MACRO_URI }}
        run: |
          # Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï†ÑÏÜ° Î∞è Ïã§Ìñâ
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            .github/deploy/deploy.sh \
            ${EC2_USER}@${EC2_HOST}:/tmp/deploy.sh
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} bash << ENDSSH
            set -e
            
            export DEPLOY_PATH="${DEPLOY_PATH}"
            export GH_TOKEN="${GH_TOKEN}"
            export SL_TOKEN="${SL_TOKEN}"
            export UP_ACCESS_KEY="${UP_ACCESS_KEY}"
            export UP_SECRET_KEY="${UP_SECRET_KEY}"
            export HT_API_KEY="${HT_API_KEY}"
            export HT_SECRET_KEY="${HT_SECRET_KEY}"
            export HT_ACCOUNT="${HT_ACCOUNT}"
            export HT_ID="${HT_ID}"
            export OPENAI_API_KEY="${OPENAI_API_KEY}"
            export GOOGLE_API_KEY="${GOOGLE_API_KEY}"
            export GEMINI_EMBEDDING_API_KEY="${GEMINI_EMBEDDING_API_KEY}"
            export TAVILY_API_KEY="${TAVILY_API_KEY}"
            export FRED_API_KEY="${FRED_API_KEY}"
            export DART_API_KEY="${DART_API_KEY}"
            export MOLIT_API_KEY="${MOLIT_API_KEY}"
            export KOSIS_API_KEY="${KOSIS_API_KEY}"
            export ECOS_API_KEY="${ECOS_API_KEY}"
            export KAKAO_SKILL_WEBHOOK_SECRET="${KAKAO_SKILL_WEBHOOK_SECRET}"
            export KR_TOP50_EARNINGS_WATCH_INTERVAL_MINUTES="${KR_TOP50_EARNINGS_WATCH_INTERVAL_MINUTES}"
            export TIER1_EVENT_SYNC_INCLUDE_KR_IR_NEWS="${TIER1_EVENT_SYNC_INCLUDE_KR_IR_NEWS}"
            export KR_TIER1_IR_FEED_URLS="${KR_TIER1_IR_FEED_URLS}"
            export GRAPH_RAG_ROUTER_LLM_TIMEOUT_SEC="${GRAPH_RAG_ROUTER_LLM_TIMEOUT_SEC}"
            export GRAPH_RAG_RECENT_DOC_PRIORITY_COUNT="${GRAPH_RAG_RECENT_DOC_PRIORITY_COUNT}"
            export GRAPH_RAG_RECENT_CITATION_TARGET_COUNT="${GRAPH_RAG_RECENT_CITATION_TARGET_COUNT}"
            export GRAPH_RAG_RECENT_CITATION_MAX_AGE_HOURS="${GRAPH_RAG_RECENT_CITATION_MAX_AGE_HOURS}"
            export GRAPH_RAG_DATA_FRESHNESS_WARN_HOURS="${GRAPH_RAG_DATA_FRESHNESS_WARN_HOURS}"
            export GRAPH_RAG_DATA_FRESHNESS_FAIL_HOURS="${GRAPH_RAG_DATA_FRESHNESS_FAIL_HOURS}"
            export GRAPH_RAG_PHASE5_ALERT_ENABLED="${GRAPH_RAG_PHASE5_ALERT_ENABLED}"
            export GRAPH_RAG_PHASE5_ALERT_ONLY_ON_WARNING="${GRAPH_RAG_PHASE5_ALERT_ONLY_ON_WARNING}"
            export GRAPH_RAG_PHASE5_ALERT_CHANNEL="${GRAPH_RAG_PHASE5_ALERT_CHANNEL}"
            export GRAPH_RAG_PHASE5_ALERT_CASE_LIMIT="${GRAPH_RAG_PHASE5_ALERT_CASE_LIMIT}"
            export GRAPH_RAG_PHASE5_ALERT_ERROR_MESSAGE_LIMIT="${GRAPH_RAG_PHASE5_ALERT_ERROR_MESSAGE_LIMIT}"
            export DOMAIN_NAME="${DOMAIN_NAME}"
            export DB_HOST="${DB_HOST}"
            export DB_PORT="${DB_PORT}"
            export DB_USER="${DB_USER}"
            export DB_PASSWORD="${DB_PASSWORD}"
            export DB_NAME="${DB_NAME}"
            export DB_CHARSET="${DB_CHARSET}"
            export DB_CHARSET="${DB_CHARSET}"
            export JWT_SECRET_KEY="${JWT_SECRET_KEY}"
            export ENCRYPTION_MASTER_KEY="${ENCRYPTION_MASTER_KEY}"
            export NEO4J_URI="${NEO4J_URI}"
            export NEO4J_USER="${NEO4J_USER}"
            export NEO4J_PASSWORD="${NEO4J_PASSWORD}"
            export NEO4J_MACRO_URI="${NEO4J_MACRO_URI}"
            
            chmod +x /tmp/deploy.sh
            /tmp/deploy.sh "${DEPLOY_PATH}" "${{ github.repository }}" "${GH_TOKEN}"
          ENDSSH
      
      - name: Health Check
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
          EC2_USER: ${{ vars.EC2_USER }}
          DEPLOY_PATH: ${{ vars.EC2_DEPLOYMENT_PATH || '/home/ec2-user/hobot-service' }}
        run: |
          sleep 10
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            echo "üîç Health Check"
            
            # Î∞±ÏóîÎìú ÏÑúÎπÑÏä§
            if sudo systemctl is-active --quiet hobot.service; then
              echo "‚úÖ Backend service: running"
            else
              echo "‚ùå Backend service: not running"
              sudo systemctl status hobot.service --no-pager -l | head -10
            fi
            
            # Î∞±ÏóîÎìú ÏßÅÏ†ë Ï†ëÍ∑º
            if curl -f http://localhost:8991/api/health > /dev/null 2>&1; then
              echo "‚úÖ Backend API: responding"
            else
              echo "‚ö†Ô∏è  Backend API: not responding"
            fi
            
            # nginx ÏÑúÎπÑÏä§
            if sudo systemctl is-active --quiet nginx; then
              echo "‚úÖ Nginx service: running"
            else
              echo "‚ùå Nginx service: not running"
            fi
            
            # ÌîÑÎ°†Ìä∏ÏóîÎìú
            DEPLOY_PATH="${DEPLOY_PATH:-/home/ec2-user/hobot-service}"
            if [ -d "${DEPLOY_PATH}/hobot-ui-v2/dist" ]; then
              echo "‚úÖ Frontend build: exists"
            else
              echo "‚ùå Frontend build: not found"
            fi
            
            # nginxÎ•º ÌÜµÌïú ÌÖåÏä§Ìä∏
            FRONTEND_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/ 2>&1)
            API_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/health 2>&1)
            
            if [ "$FRONTEND_RESPONSE" = "200" ]; then
              echo "‚úÖ Frontend (via nginx): HTTP $FRONTEND_RESPONSE"
            else
              echo "‚ùå Frontend (via nginx): HTTP $FRONTEND_RESPONSE"
            fi
            
            if [ "$API_RESPONSE" = "200" ]; then
              echo "‚úÖ Backend API (via nginx): HTTP $API_RESPONSE"
            else
              echo "‚ùå Backend API (via nginx): HTTP $API_RESPONSE"
            fi
          ENDSSH
          
      - name: Revoke Runner IP
        if: always() && steps.whitelist.outputs.skip_whitelist == 'false'
        env:
          AWS_SG_ID: ${{ secrets.AWS_SG_ID }}
          RUNNER_IP: ${{ steps.whitelist.outputs.runner_ip }}
        run: |
          echo "Revokes inbound rule from security group..."
          if [ -n "$RUNNER_IP" ] && [ -n "$AWS_SG_ID" ]; then
            aws ec2 revoke-security-group-ingress \
              --group-id $AWS_SG_ID \
              --protocol tcp \
              --port 22 \
              --cidr ${RUNNER_IP}/32
          fi
