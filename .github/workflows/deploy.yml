name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # main Î∏åÎûúÏπòÏóê pushÎê† Îïå Î∞∞Ìè¨
  workflow_dispatch:  # ÏàòÎèô Ïã§ÌñâÎèÑ Í∞ÄÎä•

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå Error: EC2_HOST variable is not set"
            exit 1
          fi
          echo "üîç Attempting to connect to EC2 host: ${EC2_HOST}"
          if ! ssh-keyscan -H ${EC2_HOST} >> ~/.ssh/known_hosts 2>&1; then
            echo "‚ùå Error: Failed to connect to EC2 host ${EC2_HOST}"
            echo "Please check:"
            echo "  1. EC2 instance is running"
            echo "  2. IP address is correct (current: ${EC2_HOST})"
            echo "  3. Security Group allows SSH (port 22) from GitHub Actions IPs"
            echo "  4. Network connectivity"
            exit 1
          fi
          echo "‚úÖ Successfully added ${EC2_HOST} to known_hosts"
      
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
          EC2_USER: ${{ vars.EC2_USER }}
          DEPLOY_PATH: ${{ vars.EC2_DEPLOYMENT_PATH || '/home/ec2-user/hobot-service' }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          # ÌôòÍ≤Ω Î≥ÄÏàò secrets (ENV_ Ï†ëÎëêÏÇ¨ ÏÇ¨Ïö©)
          SL_TOKEN: ${{ secrets.ENV_SL_TOKEN }}
          UP_ACCESS_KEY: ${{ secrets.ENV_UP_ACCESS_KEY }}
          UP_SECRET_KEY: ${{ secrets.ENV_UP_SECRET_KEY }}
          HT_API_KEY: ${{ secrets.ENV_HT_API_KEY }}
          HT_SECRET_KEY: ${{ secrets.ENV_HT_SECRET_KEY }}
          HT_ACCOUNT: ${{ secrets.ENV_HT_ACCOUNT }}
          HT_ID: ${{ secrets.ENV_HT_ID }}
          OPENAI_API_KEY: ${{ secrets.ENV_OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.ENV_GEMINI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.ENV_TAVILY_API_KEY }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << ENDSSH
            set -e
            
            export DEPLOY_PATH="${DEPLOY_PATH}"
            export GH_TOKEN="${GH_TOKEN}"
            # ÌôòÍ≤Ω Î≥ÄÏàò export (SSH ÏÑ∏ÏÖò ÎÇ¥ÏóêÏÑú ÏÇ¨Ïö©)
            export SL_TOKEN="${SL_TOKEN}"
            export UP_ACCESS_KEY="${UP_ACCESS_KEY}"
            export UP_SECRET_KEY="${UP_SECRET_KEY}"
            export HT_API_KEY="${HT_API_KEY}"
            export HT_SECRET_KEY="${HT_SECRET_KEY}"
            export HT_ACCOUNT="${HT_ACCOUNT}"
            export HT_ID="${HT_ID}"
            export OPENAI_API_KEY="${OPENAI_API_KEY}"
            export GEMINI_API_KEY="${GEMINI_API_KEY}"
            export TAVILY_API_KEY="${TAVILY_API_KEY}"
            
            echo "üöÄ Starting deployment..."
            echo "üìÅ Deploy path: \${DEPLOY_PATH}"
            
            # Î∞∞Ìè¨ ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
            cd \${DEPLOY_PATH} || {
              echo "‚ùå Deploy directory not found. Creating..."
              mkdir -p \${DEPLOY_PATH}
              cd \${DEPLOY_PATH}
            }
            
            # Git pull (ÎòêÎäî Ï¥àÍ∏∞ ÌÅ¥Î°†)
            if [ -d ".git" ]; then
              echo "üì• Pulling latest changes..."
              git pull https://\${GH_TOKEN}@github.com/${{ github.repository }}.git main || true
            else
              echo "üì• Cloning repository..."
              # Í∏∞Ï°¥ ÎîîÎ†âÌÜ†Î¶¨Í∞Ä ÎπÑÏñ¥ÏûàÏßÄ ÏïäÏúºÎ©¥ Î∞±ÏóÖ ÌõÑ ÌÅ¥Î°†
              if [ "\$(ls -A . 2>/dev/null)" ]; then
                echo "‚ö†Ô∏è Directory is not empty, backing up existing files..."
                cd ..
                BACKUP_NAME="\${DEPLOY_PATH}.backup.\$(date +%s)"
                echo "üì¶ Backing up to: \${BACKUP_NAME}"
                mv \${DEPLOY_PATH} \${BACKUP_NAME}
                mkdir -p \${DEPLOY_PATH}
                cd \${DEPLOY_PATH}
              fi
              git clone https://\${GH_TOKEN}@github.com/${{ github.repository }}.git .
            fi
            
            # Backend Î∞∞Ìè¨
            echo "üîß Setting up backend..."
            cd hobot
            
            # Python 3.12 ÌôïÏù∏
            echo "üêç Checking for Python 3.12..."
            if ! command -v python3.12 &> /dev/null; then
              echo "‚ùå Error: Python 3.12 is not installed"
              echo "Please install Python 3.12 manually before deployment."
              echo "Available Python versions:"
              command -v python3 &> /dev/null && python3 --version || echo "python3 not found"
              command -v python &> /dev/null && python --version || echo "python not found"
              exit 1
            else
              echo "‚úÖ Python 3.12 is installed"
              python3.12 --version
            fi
            
            # Python Í∞ÄÏÉÅÌôòÍ≤Ω ÏÑ§Ï†ï (uv ÏÇ¨Ïö©)
            if [ ! -d "venv" ]; then
              echo "üêç Creating virtual environment with uv..."
              
              # uv ÏÑ§Ïπò ÌôïÏù∏
              if ! command -v uv &> /dev/null; then
                echo "üì¶ uv not found. Installing uv..."
                curl -LsSf https://astral.sh/uv/install.sh | sh
                export PATH="\$HOME/.cargo/bin:\$PATH"
                # ÏÑ§Ïπò ÌôïÏù∏
                if ! command -v uv &> /dev/null; then
                  echo "‚ùå Error: Failed to install uv"
                  exit 1
                fi
                echo "‚úÖ uv installed successfully"
              else
                echo "‚úÖ uv is already installed"
                uv --version
              fi
              
              # uvÎ°ú Í∞ÄÏÉÅÌôòÍ≤Ω ÏÉùÏÑ±
              echo "üîß Creating virtual environment with uv venv venv --python 3.12..."
              if ! uv venv venv --python 3.12 2>&1; then
                echo "‚ùå Failed to create virtual environment with uv"
                exit 1
              fi
              echo "‚úÖ Virtual environment created successfully with uv"
              
              # Í∞ÄÏÉÅÌôòÍ≤Ω ÌååÏùº Í∂åÌïú ÏÑ§Ï†ï
              echo "üîß Setting permissions for virtual environment files..."
              chmod +x venv/bin/* 2>/dev/null || true
              chmod +x venv/bin/activate 2>/dev/null || true
              if [ -f "venv/bin/activate" ]; then
                chmod 755 venv/bin/activate
                echo "‚úÖ activate script permissions set"
              fi
              
              # pip ÏÑ§Ïπò (uvÎ°ú ÏÉùÏÑ±Ìïú Í∞ÄÏÉÅÌôòÍ≤ΩÏóêÎäî pipÍ∞Ä ÏóÜÏùÑ Ïàò ÏûàÏùå)
              echo "üì¶ Installing pip in virtual environment..."
              if [ -f "venv/bin/python" ]; then
                venv/bin/python -m ensurepip --upgrade --default-pip 2>&1 || {
                  echo "‚ö†Ô∏è ensurepip failed, trying get-pip.py..."
                  curl -s https://bootstrap.pypa.io/get-pip.py -o get-pip.py
                  venv/bin/python get-pip.py 2>&1
                  rm -f get-pip.py
                }
                # pip ÏÑ§Ïπò ÌôïÏù∏
                if venv/bin/python -m pip --version 2>&1; then
                  echo "‚úÖ pip installed successfully"
                else
                  echo "‚ùå Error: Failed to install pip"
                  exit 1
                fi
              else
                echo "‚ùå Error: Python executable not found in venv"
                exit 1
              fi
            else
              echo "‚úÖ Virtual environment already exists"
            fi
            
            # Í∞ÄÏÉÅÌôòÍ≤Ω ÌôïÏù∏
            if [ ! -d "venv" ]; then
              echo "‚ùå Error: venv directory was not created"
              exit 1
            fi
            echo "‚úÖ Virtual environment directory exists"
          
          # Python Ïã§Ìñâ ÌååÏùº ÌôïÏù∏ Î∞è Í∂åÌïú ÏÑ§Ï†ï
          chmod +x venv/bin/* 2>/dev/null || true
          if [ ! -f "venv/bin/python" ] || [ ! -x "venv/bin/python" ]; then
            echo "‚ùå Error: Python executable not found or not executable"
            exit 1
          fi
          
          source venv/bin/activate
          PYTHON_CMD="venv/bin/python"
          echo "üìù Using Python: \$PYTHON_CMD"
          
          # pip ÌôïÏù∏ Î∞è ÏÑ§Ïπò
          if ! \$PYTHON_CMD -m pip --version 2>&1; then
            echo "üì¶ Installing pip..."
            \$PYTHON_CMD -m ensurepip --upgrade --default-pip 2>&1 || {
              curl -s https://bootstrap.pypa.io/get-pip.py | \$PYTHON_CMD
            }
          fi
          
          # ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
          echo "üì¶ Installing Python dependencies..."
          \$PYTHON_CMD -m pip install --upgrade pip || echo "‚ö†Ô∏è pip upgrade failed, continuing..."
          \$PYTHON_CMD -m pip install -r requirements.txt
          
          # gunicorn Î™®Îìà ÌôïÏù∏
          echo "üîç Verifying gunicorn installation..."
          if ! \$PYTHON_CMD -m gunicorn --version 2>&1; then
            echo "‚ùå Error: gunicorn module not found after installation"
            echo "üìã Installed packages:"
            \$PYTHON_CMD -m pip list | grep -i gunicorn || echo "gunicorn not found in pip list"
            echo "üì¶ Attempting to install gunicorn explicitly..."
            \$PYTHON_CMD -m pip install gunicorn[gevent] || \$PYTHON_CMD -m pip install gunicorn
            if ! \$PYTHON_CMD -m gunicorn --version 2>&1; then
              echo "‚ùå Error: Failed to install gunicorn"
              exit 1
            fi
          fi
          echo "‚úÖ gunicorn module verified"
          
          # .env ÌååÏùº ÏÉùÏÑ± (GitHub Actions secretsÏóêÏÑú)
          echo "üîê Creating .env file from GitHub Actions secrets..."
          {
            echo "# Environment variables for Hobot service"
            echo "# This file is generated automatically during deployment"
            echo "# Do not commit this file to git"
            echo ""
            echo "# Slack API"
            echo "SL_TOKEN=\${SL_TOKEN}"
            echo ""
            echo "# Upbit API"
            echo "UP_ACCESS_KEY=\${UP_ACCESS_KEY}"
            echo "UP_SECRET_KEY=\${UP_SECRET_KEY}"
            echo ""
            echo "# KIS (ÌïúÍµ≠Ìà¨ÏûêÏ¶ùÍ∂å) API"
            echo "HT_API_KEY=\${HT_API_KEY}"
            echo "HT_SECRET_KEY=\${HT_SECRET_KEY}"
            echo "HT_ACCOUNT=\${HT_ACCOUNT}"
            echo "HT_ID=\${HT_ID}"
            echo ""
            echo "# OpenAI API"
            echo "OPENAI_API_KEY=\${OPENAI_API_KEY}"
            echo ""
            echo "# Gemini API"
            echo "GEMINI_API_KEY=\${GEMINI_API_KEY}"
            echo ""
            echo "# Tavily API"
            echo "TAVILY_API_KEY=\${TAVILY_API_KEY}"
          } > .env
          # .env ÌååÏùº Í∂åÌïú ÏÑ§Ï†ï (ÏÜåÏú†ÏûêÎßå ÏùΩÍ∏∞/Ïì∞Í∏∞)
          chmod 600 .env
          echo "‚úÖ .env file created successfully"
          
          # Ï†ÑÎûµ Ï¥àÍ∏∞Ìôî (KISÏôÄ UpbitÎ•º PAUSEÎ°ú ÏÑ§Ï†ï)
          echo "‚è∏Ô∏è Initializing strategies to PAUSE..."
          \$PYTHON_CMD service/utils/init_strategy_pause.py
          
          # Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          mkdir -p logs
          
          # Systemd ÏÑúÎπÑÏä§ ÏÑ§Ï†ï (ÏÑ†ÌÉùÏÇ¨Ìï≠)
          if [ -f "../.github/deploy/hobot.service" ]; then
            echo "‚öôÔ∏è Setting up systemd service..."
            sudo cp ../.github/deploy/hobot.service /etc/systemd/system/hobot.service
            # Í≤ΩÎ°ú Î∞è ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (Î™®Îì† Í≤ΩÎ°ú ÏπòÌôò)
            sudo sed -i "s|/home/ec2-user/hobot-service|\${DEPLOY_PATH}|g" /etc/systemd/system/hobot.service
            sudo sed -i "s|User=ec2-user|User=\$(whoami)|g" /etc/systemd/system/hobot.service
            # ExecStartPre Î™ÖÎ†π ÎÇ¥Î∂ÄÏùò Í≤ΩÎ°úÎèÑ ÏπòÌôò (bash -c ÎÇ¥Î∂ÄÏùò Í≤ΩÎ°ú)
            sudo sed -i "s|/home/ec2-user/hobot-service|\${DEPLOY_PATH}|g" /etc/systemd/system/hobot.service
            # Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ ÎØ∏Î¶¨ ÏÉùÏÑ± (ExecStartPreÍ∞Ä Ï†úÎåÄÎ°ú ÏûëÎèôÌïòÎèÑÎ°ù)
            sudo mkdir -p \${DEPLOY_PATH}/hobot/logs
            sudo chown -R \$(whoami):\$(whoami) \${DEPLOY_PATH}/hobot/logs
            # Python Í≤ΩÎ°ú ÌôïÏù∏ Î∞è ÏóÖÎç∞Ïù¥Ìä∏
            PYTHON_PATH=\${DEPLOY_PATH}/hobot/venv/bin/python
            if [ ! -f "\$PYTHON_PATH" ] || [ ! -x "\$PYTHON_PATH" ]; then
              echo "‚ùå Python not found or not executable at \$PYTHON_PATH"
              exit 1
            fi
            # bash -c ÌòïÏãù Ïú†ÏßÄÌïòÎ©¥ÏÑú Python Í≤ΩÎ°úÎßå ÍµêÏ≤¥
            sudo sed -i "s|/home/ec2-user/hobot-service/hobot/venv/bin/python|\$PYTHON_PATH|g" /etc/systemd/system/hobot.service
            sudo sed -i "s|\${DEPLOY_PATH}/hobot/venv/bin/python|\$PYTHON_PATH|g" /etc/systemd/system/hobot.service
            sudo systemctl daemon-reload
            sudo systemctl enable hobot.service
            echo "üîÑ Restarting service..."
            sudo systemctl restart hobot.service
            sleep 3
            # ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏
            if sudo systemctl is-active --quiet hobot.service; then
              echo "‚úÖ Service is running!"
              sudo systemctl status hobot.service --no-pager -l
            else
              echo "‚ùå Service failed to start"
              sudo systemctl status hobot.service --no-pager -l
              sudo journalctl -u hobot.service -n 30 --no-pager
              exit 1
            fi
          else
            # Systemd ÏóÜÏù¥ ÏßÅÏ†ë Ïã§Ìñâ
            echo "üõë Stopping existing services..."
            PORT=8991
            EXISTING_PIDS=\$(lsof -ti :\$PORT 2>/dev/null || true)
            if [ ! -z "\$EXISTING_PIDS" ]; then
              echo "Killing processes on port \$PORT: \$EXISTING_PIDS"
              kill -9 \$EXISTING_PIDS 2>/dev/null || true
              sleep 2
            fi
            
            # GunicornÏúºÎ°ú ÏÑúÎ≤Ñ ÏãúÏûë (Î∞±Í∑∏ÎùºÏö¥Îìú)
            echo "üöÄ Starting FastAPI server with Gunicorn..."
            # Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏
            mkdir -p logs
            # Gunicorn Ïã§Ìñâ (Î°úÍ∑∏ ÌååÏùºÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏)
            nohup \$PYTHON_CMD -m gunicorn -c gunicorn.conf.py asgi:asgi_app > logs/gunicorn.log 2>&1 &
            GUNICORN_PID=\$!
            echo "üìù Gunicorn started with PID: \$GUNICORN_PID"
            # ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä Ïã§Ï†úÎ°ú Ïã§ÌñâÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            sleep 2
            if ps -p \$GUNICORN_PID > /dev/null 2>&1; then
              echo "‚úÖ Gunicorn process is running (PID: \$GUNICORN_PID)"
            else
              echo "‚ùå Gunicorn process failed to start. Check logs/gunicorn.log for errors:"
              tail -20 logs/gunicorn.log 2>/dev/null || echo "Log file not found"
              exit 1
            fi
          fi
          
          echo "‚úÖ Backend deployment completed!"
          
          # Frontend Î∞∞Ìè¨ (nginx ÏÇ¨Ïö©)
          if [ -d "../hobot-ui" ]; then
            echo "üé® Setting up frontend with nginx..."
            cd ../hobot-ui
            
            # Node.js ÌôïÏù∏
            if command -v node &> /dev/null; then
              echo "üì¶ Installing frontend dependencies..."
              npm install
              
              # ÌîÑÎ°†Ìä∏ÏóîÎìú ÎπåÎìú (ÌÉÄÏûÑÏïÑÏõÉ Î∞©ÏßÄÎ•º ÏúÑÌï¥ Î∞±Í∑∏ÎùºÏö¥ÎìúÎ°ú Ïã§Ìñâ)
              echo "üèóÔ∏è Building frontend for production..."
              # ÎπåÎìú Î°úÍ∑∏Î•º ÌååÏùºÎ°ú Ï†ÄÏû•
              npm run build > ../hobot/logs/frontend-build.log 2>&1 &
              BUILD_PID=\$!
              echo "üìù Build started with PID: \$BUILD_PID"
              
              # ÎπåÎìú ÏôÑÎ£å ÎåÄÍ∏∞ (ÏµúÎåÄ 10Î∂Ñ)
              BUILD_TIMEOUT=600
              ELAPSED=0
              while [ \$ELAPSED -lt \$BUILD_TIMEOUT ]; do
                if ! ps -p \$BUILD_PID > /dev/null 2>&1; then
                  # ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä Ï¢ÖÎ£åÎê®
                  if [ -d "build" ]; then
                    echo "‚úÖ Frontend build completed"
                    break
                  else
                    echo "‚ùå Frontend build failed"
                    echo "üìã Build log:"
                    tail -50 ../hobot/logs/frontend-build.log 2>/dev/null || echo "Log file not found"
                    exit 1
                  fi
                fi
                sleep 5
                ELAPSED=\$((ELAPSED + 5))
                if [ \$((ELAPSED % 30)) -eq 0 ]; then
                  echo "‚è≥ Build in progress... (\$ELAPSED seconds)"
                fi
              done
              
              # ÌÉÄÏûÑÏïÑÏõÉ Ï≤¥ÌÅ¨
              if [ \$ELAPSED -ge \$BUILD_TIMEOUT ]; then
                echo "‚ö†Ô∏è Build timeout, but checking if build directory exists..."
                if [ -d "build" ]; then
                  echo "‚úÖ Build directory found (may have completed)"
                else
                  echo "‚ùå Build timeout and no build directory found"
                  tail -50 ../hobot/logs/frontend-build.log 2>/dev/null || echo "Log file not found"
                  exit 1
                fi
              fi
              
              if [ ! -d "build" ]; then
                echo "‚ùå Frontend build failed - build directory not found"
                tail -50 ../hobot/logs/frontend-build.log 2>/dev/null || echo "Log file not found"
                exit 1
              fi
              
              # nginx ÏÑ§Ïπò ÌôïÏù∏
              if ! command -v nginx &> /dev/null; then
                echo "üì¶ Installing nginx..."
                sudo yum install -y nginx || sudo apt-get update && sudo apt-get install -y nginx
              fi
              
              # nginx ÏÑ§Ï†ï ÌååÏùº Î≥µÏÇ¨
              if [ -f "../.github/deploy/nginx.conf" ]; then
                echo "‚öôÔ∏è Configuring nginx..."
                # Í≤ΩÎ°ú ÏπòÌôò
                sudo cp ../.github/deploy/nginx.conf /etc/nginx/conf.d/hobot.conf
                sudo sed -i "s|/home/ec2-user/hobot-service|\${DEPLOY_PATH}|g" /etc/nginx/conf.d/hobot.conf
                
                # nginx ÏÑ§Ï†ï ÌÖåÏä§Ìä∏
                if sudo nginx -t; then
                  echo "‚úÖ Nginx configuration is valid"
                  # nginx Ïû¨ÏãúÏûë
                  sudo systemctl enable nginx
                  sudo systemctl restart nginx
                  echo "‚úÖ Nginx restarted"
                else
                  echo "‚ùå Nginx configuration test failed"
                  exit 1
                fi
              else
                echo "‚ö†Ô∏è nginx.conf not found, skipping nginx setup"
              fi
            else
              echo "‚ö†Ô∏è Node.js not found, skipping frontend deployment"
            fi
          fi
          
          echo "üéâ Deployment completed successfully!"
          ENDSSH
      
      - name: Health Check
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
          EC2_USER: ${{ vars.EC2_USER }}
        run: |
          sleep 10  # ÏÑúÎ≤Ñ ÏãúÏûë ÎåÄÍ∏∞
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            echo "üîç Checking server health..."
            # nginxÎ•º ÌÜµÌïú ÌîÑÎ°†Ìä∏ÏóîÎìú Ï≤¥ÌÅ¨
            if curl -f http://localhost/ > /dev/null 2>&1; then
              echo "‚úÖ Frontend (nginx) is healthy!"
            else
              echo "‚ùå Frontend (nginx) health check failed"
              exit 1
            fi
            # Î∞±ÏóîÎìú API Ï≤¥ÌÅ¨
            if curl -f http://localhost/api/health > /dev/null 2>&1; then
              echo "‚úÖ Backend API is healthy!"
            else
              echo "‚ùå Backend API health check failed"
              exit 1
            fi
          ENDSSH

