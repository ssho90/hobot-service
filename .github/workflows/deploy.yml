name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— pushë  ë•Œ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      env:
        EC2_HOST: ${{ vars.EC2_HOST }}
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        if [ -z "$EC2_HOST" ]; then
          echo "âŒ Error: EC2_HOST variable is not set"
          exit 1
        fi
        ssh-keyscan -H ${EC2_HOST} >> ~/.ssh/known_hosts
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ vars.EC2_HOST }}
        EC2_USER: ${{ vars.EC2_USER }}
        DEPLOY_PATH: ${{ vars.EC2_DEPLOYMENT_PATH || '/home/ec2-user/hobot-service' }}
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          set -e
          
          echo "ğŸš€ Starting deployment..."
          
          # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd ${DEPLOY_PATH} || {
            echo "âŒ Deploy directory not found. Creating..."
            mkdir -p ${DEPLOY_PATH}
            cd ${DEPLOY_PATH}
          }
          
          # Git pull (ë˜ëŠ” ì´ˆê¸° í´ë¡ )
          if [ -d ".git" ]; then
            echo "ğŸ“¥ Pulling latest changes..."
            git pull https://${GH_TOKEN}@github.com/${{ github.repository }}.git main || true
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://${GH_TOKEN}@github.com/${{ github.repository }}.git .
          fi
          
          # Backend ë°°í¬
          echo "ğŸ”§ Setting up backend..."
          cd hobot
          
          # Python ê°€ìƒí™˜ê²½ ì„¤ì •
          if [ ! -d "venv" ]; then
            echo "ğŸ Creating virtual environment..."
            python3 -m venv venv
          fi
          
          source venv/bin/activate
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ Installing Python dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # ì „ëµ ì´ˆê¸°í™” (KISì™€ Upbitë¥¼ PAUSEë¡œ ì„¤ì •)
          echo "â¸ï¸ Initializing strategies to PAUSE..."
          python3 service/utils/init_strategy_pause.py
          
          # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p logs
          
          # Systemd ì„œë¹„ìŠ¤ ì„¤ì • (ì„ íƒì‚¬í•­)
          if [ -f "../.github/deploy/hobot.service" ]; then
            echo "âš™ï¸ Setting up systemd service..."
            sudo cp ../.github/deploy/hobot.service /etc/systemd/system/hobot.service
            sudo sed -i "s|/home/ubuntu/hobot-service|${DEPLOY_PATH}|g" /etc/systemd/system/hobot.service
            sudo systemctl daemon-reload
            sudo systemctl enable hobot.service
            echo "ğŸ”„ Restarting service..."
            sudo systemctl restart hobot.service
            echo "âœ… Service restarted!"
          else
            # Systemd ì—†ì´ ì§ì ‘ ì‹¤í–‰
            echo "ğŸ›‘ Stopping existing services..."
            PORT=8991
            EXISTING_PIDS=$(lsof -ti :$PORT 2>/dev/null || true)
            if [ ! -z "$EXISTING_PIDS" ]; then
              echo "Killing processes on port $PORT: $EXISTING_PIDS"
              kill -9 $EXISTING_PIDS 2>/dev/null || true
              sleep 2
            fi
            
            # Gunicornìœ¼ë¡œ ì„œë²„ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
            echo "ğŸš€ Starting FastAPI server with Gunicorn..."
            nohup python3 -m gunicorn -c gunicorn.conf.py asgi:asgi_app > /dev/null 2>&1 &
          fi
          
          echo "âœ… Backend deployment completed!"
          
          # Frontend ë°°í¬ (ì„ íƒì‚¬í•­)
          if [ -d "../hobot-ui" ]; then
            echo "ğŸ¨ Setting up frontend..."
            cd ../hobot-ui
            
            # Node.js í™•ì¸
            if command -v node &> /dev/null; then
              echo "ğŸ“¦ Installing frontend dependencies..."
              npm install --production
              
              # ë¹Œë“œ (í”„ë¡œë•ì…˜)
              echo "ğŸ—ï¸ Building frontend..."
              npm run build || echo "âš ï¸ Build script not found, skipping..."
            else
              echo "âš ï¸ Node.js not found, skipping frontend deployment"
            fi
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
        ENDSSH
    
    - name: Health Check
      env:
        EC2_HOST: ${{ vars.EC2_HOST }}
        EC2_USER: ${{ vars.EC2_USER }}
      run: |
        sleep 10  # ì„œë²„ ì‹œì‘ ëŒ€ê¸°
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          echo "ğŸ” Checking server health..."
          if curl -f http://localhost:8991/ > /dev/null 2>&1; then
            echo "âœ… Backend server is healthy!"
          else
            echo "âŒ Backend server health check failed"
            exit 1
          fi
        ENDSSH

