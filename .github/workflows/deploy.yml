name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå Error: EC2_HOST variable is not set"
            exit 1
          fi
          
          echo "üîç Connecting to EC2 host: ${EC2_HOST}"
          ssh-keyscan -H ${EC2_HOST} >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ùå Failed to connect to EC2 host"
            exit 1
          }
          echo "‚úÖ SSH connection ready"
      
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
          EC2_USER: ${{ vars.EC2_USER }}
          DEPLOY_PATH: ${{ vars.EC2_DEPLOYMENT_PATH || '/home/ec2-user/hobot-service' }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          SL_TOKEN: ${{ secrets.ENV_SL_TOKEN }}
          UP_ACCESS_KEY: ${{ secrets.ENV_UP_ACCESS_KEY }}
          UP_SECRET_KEY: ${{ secrets.ENV_UP_SECRET_KEY }}
          HT_API_KEY: ${{ secrets.ENV_HT_API_KEY }}
          HT_SECRET_KEY: ${{ secrets.ENV_HT_SECRET_KEY }}
          HT_ACCOUNT: ${{ secrets.ENV_HT_ACCOUNT }}
          HT_ID: ${{ secrets.ENV_HT_ID }}
          OPENAI_API_KEY: ${{ secrets.ENV_OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.ENV_GOOGLE_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.ENV_TAVILY_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          # MySQL Database Configuration
          DB_HOST: ${{ vars.DB_HOST || secrets.DB_HOST }}
          DB_PORT: ${{ vars.DB_PORT || '3306' }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ vars.DB_NAME || 'hobot' }}
          DB_CHARSET: ${{ vars.DB_CHARSET || 'utf8mb4' }}
          # JWT Secret Key
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        run: |
          # Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï†ÑÏÜ° Î∞è Ïã§Ìñâ
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            .github/deploy/deploy.sh \
            ${EC2_USER}@${EC2_HOST}:/tmp/deploy.sh
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} bash << ENDSSH
            set -e
            
            export DEPLOY_PATH="${DEPLOY_PATH}"
            export GH_TOKEN="${GH_TOKEN}"
            export SL_TOKEN="${SL_TOKEN}"
            export UP_ACCESS_KEY="${UP_ACCESS_KEY}"
            export UP_SECRET_KEY="${UP_SECRET_KEY}"
            export HT_API_KEY="${HT_API_KEY}"
            export HT_SECRET_KEY="${HT_SECRET_KEY}"
            export HT_ACCOUNT="${HT_ACCOUNT}"
            export HT_ID="${HT_ID}"
            export OPENAI_API_KEY="${OPENAI_API_KEY}"
            export GOOGLE_API_KEY="${GOOGLE_API_KEY}"
            export TAVILY_API_KEY="${TAVILY_API_KEY}"
            export FRED_API_KEY="${FRED_API_KEY}"
            export DOMAIN_NAME="${DOMAIN_NAME}"
            export DB_HOST="${DB_HOST}"
            export DB_PORT="${DB_PORT}"
            export DB_USER="${DB_USER}"
            export DB_PASSWORD="${DB_PASSWORD}"
            export DB_NAME="${DB_NAME}"
            export DB_CHARSET="${DB_CHARSET}"
            export JWT_SECRET_KEY="${JWT_SECRET_KEY}"
            
            chmod +x /tmp/deploy.sh
            /tmp/deploy.sh "${DEPLOY_PATH}" "${{ github.repository }}" "${GH_TOKEN}"
          ENDSSH
      
      - name: Health Check
        env:
          EC2_HOST: ${{ vars.EC2_HOST }}
          EC2_USER: ${{ vars.EC2_USER }}
          DEPLOY_PATH: ${{ vars.EC2_DEPLOYMENT_PATH || '/home/ec2-user/hobot-service' }}
        run: |
          sleep 10
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            echo "üîç Health Check"
            
            # Î∞±ÏóîÎìú ÏÑúÎπÑÏä§
            if sudo systemctl is-active --quiet hobot.service; then
              echo "‚úÖ Backend service: running"
            else
              echo "‚ùå Backend service: not running"
              sudo systemctl status hobot.service --no-pager -l | head -10
            fi
            
            # Î∞±ÏóîÎìú ÏßÅÏ†ë Ï†ëÍ∑º
            if curl -f http://localhost:8991/api/health > /dev/null 2>&1; then
              echo "‚úÖ Backend API: responding"
            else
              echo "‚ö†Ô∏è  Backend API: not responding"
            fi
            
            # nginx ÏÑúÎπÑÏä§
            if sudo systemctl is-active --quiet nginx; then
              echo "‚úÖ Nginx service: running"
            else
              echo "‚ùå Nginx service: not running"
            fi
            
            # ÌîÑÎ°†Ìä∏ÏóîÎìú
            DEPLOY_PATH="${DEPLOY_PATH:-/home/ec2-user/hobot-service}"
            if [ -d "${DEPLOY_PATH}/hobot-ui/build" ]; then
              echo "‚úÖ Frontend build: exists"
            else
              echo "‚ùå Frontend build: not found"
            fi
            
            # nginxÎ•º ÌÜµÌïú ÌÖåÏä§Ìä∏
            FRONTEND_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/ 2>&1)
            API_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/health 2>&1)
            
            if [ "$FRONTEND_RESPONSE" = "200" ]; then
              echo "‚úÖ Frontend (via nginx): HTTP $FRONTEND_RESPONSE"
            else
              echo "‚ùå Frontend (via nginx): HTTP $FRONTEND_RESPONSE"
            fi
            
            if [ "$API_RESPONSE" = "200" ]; then
              echo "‚úÖ Backend API (via nginx): HTTP $API_RESPONSE"
            else
              echo "‚ùå Backend API (via nginx): HTTP $API_RESPONSE"
            fi
          ENDSSH
