[Unit]
Description=Hobot FastAPI Service
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/home/ec2-user/hobot-service/hobot
Environment="PATH=/home/ec2-user/hobot-service/hobot/venv/bin:/usr/local/bin:/usr/bin:/bin"
Environment="PYTHONPATH=/home/ec2-user/hobot-service/hobot"
# .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (dotenvê°€ ìë™ìœ¼ë¡œ ë¡œë“œí•¨)
EnvironmentFile=-/home/ec2-user/hobot-service/hobot/.env
# Python ëª¨ë“ˆë¡œ ì‹¤í–‰í•˜ì—¬ ê°€ìƒí™˜ê²½ì˜ Pythonì„ ì‚¬ìš©
# bashë¥¼ ì‚¬ìš©í•˜ì—¬ ëª…ì‹œì ìœ¼ë¡œ ì‹¤í–‰ (203/EXEC ì—ëŸ¬ ë°©ì§€)
ExecStart=/bin/bash -c "cd /home/ec2-user/hobot-service/hobot && /home/ec2-user/hobot-service/hobot/venv/bin/python -m gunicorn -c gunicorn.conf.py asgi:asgi_app"
Restart=always
RestartSec=10

# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
ExecStartPre=/bin/mkdir -p /home/ec2-user/hobot-service/hobot/logs
ExecStartPre=/bin/chmod 755 /home/ec2-user/hobot-service/hobot/logs

# Python ì‹¤í–‰ íŒŒì¼ ê²€ì¦ ë° ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
ExecStartPre=/bin/bash -c "echo 'ğŸ” Checking Python executable...'"
ExecStartPre=/bin/bash -c "if [ ! -f /home/ec2-user/hobot-service/hobot/venv/bin/python ]; then echo 'âŒ ERROR: Python executable NOT FOUND at /home/ec2-user/hobot-service/hobot/venv/bin/python'; ls -la /home/ec2-user/hobot-service/hobot/venv/bin/ 2>&1 || echo 'venv/bin directory does not exist'; exit 1; fi"
ExecStartPre=/bin/bash -c "if [ ! -x /home/ec2-user/hobot-service/hobot/venv/bin/python ]; then echo 'âŒ ERROR: Python executable NOT EXECUTABLE (permissions issue)!'; ls -la /home/ec2-user/hobot-service/hobot/venv/bin/python; exit 1; fi"
ExecStartPre=/bin/bash -c "echo 'âœ… Python executable found and is executable'"
ExecStartPre=/bin/bash -c "/home/ec2-user/hobot-service/hobot/venv/bin/python --version 2>&1 || echo 'âš ï¸ Could not get Python version'"
ExecStartPre=/bin/bash -c "echo 'ğŸ“ Working directory: /home/ec2-user/hobot-service/hobot'"
ExecStartPre=/bin/bash -c "ls -la /home/ec2-user/hobot-service/hobot/venv/bin/python* 2>&1 || echo 'No Python files found in venv/bin'"
ExecStartPre=/bin/bash -c "cd /home/ec2-user/hobot-service/hobot && echo 'ğŸ” Checking gunicorn module...' && /home/ec2-user/hobot-service/hobot/venv/bin/python -m gunicorn --version 2>&1 || (echo 'âŒ ERROR: gunicorn module not found'; /home/ec2-user/hobot-service/hobot/venv/bin/python -m pip list | grep -i gunicorn || echo 'gunicorn not in pip list'; exit 1)"
ExecStartPre=/bin/bash -c "cd /home/ec2-user/hobot-service/hobot && echo 'ğŸ” Checking gunicorn.conf.py...' && if [ ! -f gunicorn.conf.py ]; then echo 'âŒ ERROR: gunicorn.conf.py not found'; ls -la *.py 2>&1; exit 1; else echo 'âœ… gunicorn.conf.py found'; fi"
ExecStartPre=/bin/bash -c "cd /home/ec2-user/hobot-service/hobot && echo 'ğŸ” Checking asgi.py...' && if [ ! -f asgi.py ]; then echo 'âŒ ERROR: asgi.py not found'; ls -la *.py 2>&1; exit 1; else echo 'âœ… asgi.py found'; fi"
ExecStartPre=/bin/bash -c "cd /home/ec2-user/hobot-service/hobot && echo 'ğŸ” Testing Python import...' && export PYTHONPATH=/home/ec2-user/hobot-service/hobot && timeout 30 /home/ec2-user/hobot-service/hobot/venv/bin/python -c 'import sys; sys.path.insert(0, \"/home/ec2-user/hobot-service/hobot\"); import gunicorn; print(\"âœ… gunicorn imported\"); import asgi; print(\"âœ… asgi imported\"); from main import app; print(\"âœ… main.app imported\"); print(\"âœ… All imports successful\")' 2>&1 || (echo 'âŒ ERROR: Import test failed or timed out'; echo 'Checking environment variables...'; env | grep -E '^DB_|^JWT_' || echo 'No DB_ or JWT_ environment variables found'; /home/ec2-user/hobot-service/hobot/venv/bin/python -c 'import sys; print(\"Python path:\", sys.path)' 2>&1; exit 1)"

# ë¡œê·¸ ì„¤ì • (journalë¡œ ë¨¼ì € ì„¤ì •, íŒŒì¼ ë¦¬ë‹¤ì´ë ‰ì…˜ì€ gunicorn.conf.pyì—ì„œ ì²˜ë¦¬)
StandardOutput=journal
StandardError=journal
SyslogIdentifier=hobot

[Install]
WantedBy=multi-user.target